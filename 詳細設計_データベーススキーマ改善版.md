# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒè©³ç´°è¨­è¨ˆï¼ˆæ”¹å–„ç‰ˆï¼‰

## ğŸ“‹ ç›®æ¬¡
1. [å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
2. [ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©](#ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©)
3. [ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥](#ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥)
4. [ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°æˆ¦ç•¥](#ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°æˆ¦ç•¥)
5. [ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»](#ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»)

---

## ğŸ— å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹æˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Primary Database (MySQL 8.0)          â”‚
â”‚  - InnoDB Engine                                        â”‚
â”‚  - utf8mb4_unicode_ci                                   â”‚
â”‚  - Row Format: DYNAMIC                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Read Replica 1 (èª­ã¿å–ã‚Šå°‚ç”¨)                â”‚
â”‚  - ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆç”¨                                         â”‚
â”‚  - åˆ†æã‚¯ã‚¨ãƒªç”¨                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Read Replica 2 (èª­ã¿å–ã‚Šå°‚ç”¨)                â”‚
â”‚  - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨                                         â”‚
â”‚  - DR (ç½å®³å¾©æ—§)ç”¨                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

### 1. users ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆçµ±åˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

```sql
CREATE TABLE users (
    -- ä¸»ã‚­ãƒ¼
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    uuid CHAR(36) NOT NULL UNIQUE COMMENT 'UUID v4',

    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—
    user_type ENUM('admin', 'affiliate', 'advertiser') NOT NULL COMMENT 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¨®åˆ¥',

    -- èªè¨¼æƒ…å ±
    email VARCHAR(255) NOT NULL UNIQUE,
    email_verified_at TIMESTAMP NULL,
    password VARCHAR(255) NOT NULL COMMENT 'bcrypt/argon2ãƒãƒƒã‚·ãƒ¥',
    password_changed_at TIMESTAMP NULL COMMENT 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœ€çµ‚å¤‰æ›´æ—¥æ™‚',
    password_expires_at TIMESTAMP NULL COMMENT 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœ‰åŠ¹æœŸé™',

    -- 2è¦ç´ èªè¨¼
    two_factor_secret VARCHAR(255) NULL COMMENT 'TOTPç§˜å¯†éµ',
    two_factor_recovery_codes TEXT NULL COMMENT 'ãƒªã‚«ãƒãƒªãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆJSONï¼‰',
    two_factor_enabled BOOLEAN DEFAULT FALSE,

    -- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
    username VARCHAR(100) UNIQUE,
    display_name VARCHAR(255),
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    company_name VARCHAR(255),
    phone VARCHAR(20),
    country_code CHAR(2) COMMENT 'ISO 3166-1 alpha-2',
    language_code CHAR(2) DEFAULT 'ja' COMMENT 'ISO 639-1',
    timezone VARCHAR(50) DEFAULT 'Asia/Tokyo',
    avatar_url VARCHAR(500),

    -- ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆå›ºæœ‰æƒ…å ±
    affiliate_code VARCHAR(20) UNIQUE COMMENT 'ç´¹ä»‹ã‚³ãƒ¼ãƒ‰',
    referrer_id BIGINT UNSIGNED NULL COMMENT 'ç´¹ä»‹è€…ID',
    tier_level TINYINT UNSIGNED DEFAULT 0 COMMENT 'éšå±¤ãƒ¬ãƒ™ãƒ« (0-3)',
    rank_id BIGINT UNSIGNED NULL COMMENT 'ãƒ©ãƒ³ã‚¯ID',

    -- è²¡å‹™æƒ…å ±
    balance DECIMAL(15, 2) DEFAULT 0.00 COMMENT 'åˆ©ç”¨å¯èƒ½æ®‹é«˜',
    pending_balance DECIMAL(15, 2) DEFAULT 0.00 COMMENT 'ä¿ç•™æ®‹é«˜',
    total_earned DECIMAL(15, 2) DEFAULT 0.00 COMMENT 'ç´¯è¨ˆå ±é…¬',
    total_paid DECIMAL(15, 2) DEFAULT 0.00 COMMENT 'ç´¯è¨ˆæ”¯æ‰•é¡',
    tier_earnings DECIMAL(15, 2) DEFAULT 0.00 COMMENT 'ãƒ†ã‚£ã‚¢å ±é…¬ç´¯è¨ˆ',

    -- KYC (æœ¬äººç¢ºèª)
    kyc_status ENUM('none', 'pending', 'approved', 'rejected') DEFAULT 'none',
    kyc_verified_at TIMESTAMP NULL,
    kyc_document_url VARCHAR(500),

    -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    status ENUM('active', 'inactive', 'suspended', 'banned') DEFAULT 'active',
    email_notifications BOOLEAN DEFAULT TRUE,
    sms_notifications BOOLEAN DEFAULT FALSE,

    -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
    last_login_at TIMESTAMP NULL,
    last_login_ip VARCHAR(45),
    failed_login_attempts TINYINT UNSIGNED DEFAULT 0,
    locked_until TIMESTAMP NULL,

    -- API
    api_token VARCHAR(80) UNIQUE,
    api_rate_limit INT UNSIGNED DEFAULT 1000 COMMENT 'æ™‚é–“å½“ãŸã‚Šãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°',

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL COMMENT 'ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆ',

    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    INDEX idx_user_type (user_type, status),
    INDEX idx_email (email),
    INDEX idx_referrer (referrer_id),
    INDEX idx_status (status, created_at),
    INDEX idx_affiliate_code (affiliate_code),
    INDEX idx_created_at (created_at),

    -- å¤–éƒ¨ã‚­ãƒ¼
    FOREIGN KEY (referrer_id) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (rank_id) REFERENCES ranks(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 2. campaigns ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆåºƒå‘Šã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ï¼‰

```sql
CREATE TABLE campaigns (
    -- ä¸»ã‚­ãƒ¼
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    uuid CHAR(36) NOT NULL UNIQUE,

    -- æ‰€æœ‰è€…
    advertiser_id BIGINT UNSIGNED NOT NULL COMMENT 'åºƒå‘Šä¸»ID',

    -- åŸºæœ¬æƒ…å ±
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) UNIQUE,
    description TEXT,
    category_id BIGINT UNSIGNED,

    -- URLè¨­å®š
    destination_url VARCHAR(2048) NOT NULL COMMENT 'é·ç§»å…ˆURL',
    destination_url_mobile VARCHAR(2048) COMMENT 'ãƒ¢ãƒã‚¤ãƒ«ç”¨URL',
    tracking_domain VARCHAR(255) COMMENT 'ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³',

    -- å ±é…¬è¨­å®š
    commission_type ENUM('fixed', 'percentage', 'tiered', 'custom') NOT NULL,
    commission_value DECIMAL(10, 2) NOT NULL COMMENT 'å›ºå®šé¡ or ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸',
    commission_currency CHAR(3) DEFAULT 'JPY',

    -- ã‚¯ãƒªãƒƒã‚¯å ±é…¬
    click_commission DECIMAL(10, 2) DEFAULT 0.00,
    click_enabled BOOLEAN DEFAULT FALSE,

    -- äºˆç®—ç®¡ç†
    budget_type ENUM('unlimited', 'daily', 'monthly', 'total', 'conversions') DEFAULT 'unlimited',
    budget_amount DECIMAL(15, 2),
    budget_spent DECIMAL(15, 2) DEFAULT 0.00,

    -- ãƒ†ã‚£ã‚¢å ±é…¬è¨­å®š
    tier1_rate DECIMAL(5, 2) DEFAULT 0.00 COMMENT 'å­ã¸ã®å ±é…¬ç‡(%)',
    tier2_rate DECIMAL(5, 2) DEFAULT 0.00 COMMENT 'å­«ã¸ã®å ±é…¬ç‡(%)',
    tier3_rate DECIMAL(5, 2) DEFAULT 0.00 COMMENT 'ã²å­«ã¸ã®å ±é…¬ç‡(%)',

    -- ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°
    geo_targeting JSON COMMENT 'åœ°åŸŸã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°ï¼ˆå›½ã‚³ãƒ¼ãƒ‰é…åˆ—ï¼‰',
    device_targeting JSON COMMENT 'ãƒ‡ãƒã‚¤ã‚¹ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°',
    time_targeting JSON COMMENT 'æ™‚é–“å¸¯ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°',

    -- ã‚¯ãƒªãƒƒã‚¯åˆ¶é™
    click_interval_seconds INT UNSIGNED DEFAULT 3600 COMMENT 'é‡è¤‡ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šæ™‚é–“',
    conversion_window_hours INT UNSIGNED DEFAULT 720 COMMENT 'ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³æœ‰åŠ¹æœŸé–“(30æ—¥)',

    -- æ‰¿èªãƒ•ãƒ­ãƒ¼
    auto_approve_conversions BOOLEAN DEFAULT FALSE,
    auto_approve_clicks BOOLEAN DEFAULT TRUE,

    -- çµ±è¨ˆæƒ…å ±ï¼ˆéæ­£è¦åŒ–ï¼‰
    total_clicks BIGINT UNSIGNED DEFAULT 0,
    total_conversions BIGINT UNSIGNED DEFAULT 0,
    total_revenue DECIMAL(15, 2) DEFAULT 0.00,
    conversion_rate DECIMAL(5, 2) DEFAULT 0.00 COMMENT 'CVR(%)',

    -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    status ENUM('draft', 'pending', 'active', 'paused', 'completed', 'archived') DEFAULT 'draft',
    visibility ENUM('public', 'private', 'invite_only') DEFAULT 'public',

    -- æ²è¼‰æœŸé–“
    starts_at TIMESTAMP NULL,
    ends_at TIMESTAMP NULL,

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,

    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    INDEX idx_advertiser (advertiser_id, status),
    INDEX idx_status (status, visibility),
    INDEX idx_category (category_id),
    INDEX idx_dates (starts_at, ends_at),
    INDEX idx_slug (slug),

    -- å¤–éƒ¨ã‚­ãƒ¼
    FOREIGN KEY (advertiser_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 3. clicks ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚¯ãƒªãƒƒã‚¯ãƒ­ã‚° - ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰

```sql
CREATE TABLE clicks (
    -- ä¸»ã‚­ãƒ¼
    id BIGINT UNSIGNED AUTO_INCREMENT,
    uuid CHAR(36) NOT NULL,

    -- é–¢é€£æƒ…å ±
    campaign_id BIGINT UNSIGNED NOT NULL,
    affiliate_id BIGINT UNSIGNED NOT NULL,

    -- ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°æƒ…å ±
    tracking_id VARCHAR(64) UNIQUE COMMENT 'ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ID',

    -- ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±
    ip_address VARCHAR(45) NOT NULL,
    user_agent TEXT,
    referer TEXT,

    -- ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ï¼ˆãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ï¼‰
    device_type ENUM('desktop', 'mobile', 'tablet', 'bot') DEFAULT 'desktop',
    browser VARCHAR(50),
    os VARCHAR(50),

    -- åœ°ç†æƒ…å ±
    country_code CHAR(2),
    region VARCHAR(100),
    city VARCHAR(100),
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),

    -- UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    utm_source VARCHAR(255),
    utm_medium VARCHAR(255),
    utm_campaign VARCHAR(255),
    utm_term VARCHAR(255),
    utm_content VARCHAR(255),

    -- Cookie/ã‚»ãƒƒã‚·ãƒ§ãƒ³
    cookie_id VARCHAR(64),
    session_id VARCHAR(64),
    fingerprint VARCHAR(64) COMMENT 'ãƒ‡ãƒã‚¤ã‚¹ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ',

    -- ä¸æ­£æ¤œçŸ¥
    fraud_score TINYINT UNSIGNED DEFAULT 0 COMMENT '0-100',
    is_suspicious BOOLEAN DEFAULT FALSE,
    fraud_reason VARCHAR(255),

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    clicked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- ä¸»ã‚­ãƒ¼ï¼ˆãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ã‚’å«ã‚€ï¼‰
    PRIMARY KEY (id, clicked_at),

    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    INDEX idx_campaign (campaign_id, clicked_at),
    INDEX idx_affiliate (affiliate_id, clicked_at),
    INDEX idx_tracking (tracking_id),
    INDEX idx_cookie (cookie_id),
    INDEX idx_suspicious (is_suspicious, clicked_at)

) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
PARTITION BY RANGE (UNIX_TIMESTAMP(clicked_at)) (
    PARTITION p202401 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-01')),
    PARTITION p202402 VALUES LESS THAN (UNIX_TIMESTAMP('2024-03-01')),
    PARTITION p202403 VALUES LESS THAN (UNIX_TIMESTAMP('2024-04-01')),
    PARTITION p202404 VALUES LESS THAN (UNIX_TIMESTAMP('2024-05-01')),
    PARTITION p202405 VALUES LESS THAN (UNIX_TIMESTAMP('2024-06-01')),
    PARTITION p202406 VALUES LESS THAN (UNIX_TIMESTAMP('2024-07-01')),
    PARTITION p202407 VALUES LESS THAN (UNIX_TIMESTAMP('2024-08-01')),
    PARTITION p202408 VALUES LESS THAN (UNIX_TIMESTAMP('2024-09-01')),
    PARTITION p202409 VALUES LESS THAN (UNIX_TIMESTAMP('2024-10-01')),
    PARTITION p202410 VALUES LESS THAN (UNIX_TIMESTAMP('2024-11-01')),
    PARTITION p202411 VALUES LESS THAN (UNIX_TIMESTAMP('2024-12-01')),
    PARTITION p202412 VALUES LESS THAN (UNIX_TIMESTAMP('2025-01-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è‡ªå‹•è¿½åŠ ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæœˆæ¬¡å®Ÿè¡Œï¼‰
-- ALTER TABLE clicks REORGANIZE PARTITION p_future INTO (
--     PARTITION p202501 VALUES LESS THAN (UNIX_TIMESTAMP('2025-02-01')),
--     PARTITION p_future VALUES LESS THAN MAXVALUE
-- );
```

---

### 4. conversions ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰

```sql
CREATE TABLE conversions (
    -- ä¸»ã‚­ãƒ¼
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    uuid CHAR(36) NOT NULL UNIQUE,

    -- é–¢é€£æƒ…å ±
    campaign_id BIGINT UNSIGNED NOT NULL,
    affiliate_id BIGINT UNSIGNED NOT NULL,
    click_id BIGINT UNSIGNED COMMENT 'å…ƒã‚¯ãƒªãƒƒã‚¯ID',

    -- ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
    tracking_id VARCHAR(64),
    order_id VARCHAR(100) COMMENT 'ECæ³¨æ–‡ID',

    -- é‡‘é¡æƒ…å ±
    order_amount DECIMAL(15, 2) NOT NULL COMMENT 'æ³¨æ–‡é‡‘é¡',
    commission_amount DECIMAL(15, 2) NOT NULL COMMENT 'å ±é…¬é¡',
    currency CHAR(3) DEFAULT 'JPY',

    -- å•†å“æƒ…å ±
    product_id VARCHAR(100),
    product_name VARCHAR(255),
    product_category VARCHAR(100),
    quantity INT UNSIGNED DEFAULT 1,

    -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    status ENUM('pending', 'approved', 'rejected', 'cancelled', 'refunded') DEFAULT 'pending',
    approval_status_changed_at TIMESTAMP NULL,
    approved_by BIGINT UNSIGNED COMMENT 'æ‰¿èªè€…ID',
    rejection_reason TEXT,

    -- é¡§å®¢æƒ…å ±ï¼ˆãƒãƒƒã‚·ãƒ¥åŒ–ï¼‰
    customer_email_hash VARCHAR(64) COMMENT 'SHA256ãƒãƒƒã‚·ãƒ¥',
    customer_id_hash VARCHAR(64),
    is_new_customer BOOLEAN DEFAULT TRUE,

    -- ãƒ†ã‚£ã‚¢å ±é…¬
    tier1_commission DECIMAL(10, 2) DEFAULT 0.00,
    tier2_commission DECIMAL(10, 2) DEFAULT 0.00,
    tier3_commission DECIMAL(10, 2) DEFAULT 0.00,

    -- ä¸æ­£æ¤œçŸ¥
    fraud_score TINYINT UNSIGNED DEFAULT 0,
    is_suspicious BOOLEAN DEFAULT FALSE,
    fraud_checks JSON COMMENT 'ä¸æ­£æ¤œçŸ¥çµæœ',

    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    metadata JSON COMMENT 'ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿',

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    converted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    INDEX idx_campaign (campaign_id, status, converted_at),
    INDEX idx_affiliate (affiliate_id, status, converted_at),
    INDEX idx_status (status, converted_at),
    INDEX idx_order (order_id),
    INDEX idx_suspicious (is_suspicious, status),

    -- å¤–éƒ¨ã‚­ãƒ¼
    FOREIGN KEY (campaign_id) REFERENCES campaigns(id) ON DELETE CASCADE,
    FOREIGN KEY (affiliate_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (approved_by) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 5. payments ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ”¯æ‰•ã„å±¥æ­´ï¼‰

```sql
CREATE TABLE payments (
    -- ä¸»ã‚­ãƒ¼
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    uuid CHAR(36) NOT NULL UNIQUE,

    -- é–¢é€£æƒ…å ±
    affiliate_id BIGINT UNSIGNED NOT NULL,

    -- é‡‘é¡
    amount DECIMAL(15, 2) NOT NULL,
    currency CHAR(3) DEFAULT 'JPY',

    -- æ”¯æ‰•ã„æ–¹æ³•
    payment_method ENUM('bank_transfer', 'paypal', 'stripe', 'crypto', 'other') NOT NULL,
    payment_method_details JSON COMMENT 'æ”¯æ‰•å…ˆæƒ…å ±ï¼ˆæš—å·åŒ–ï¼‰',

    -- å¯¾è±¡æœŸé–“
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,

    -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    status ENUM('pending', 'processing', 'completed', 'failed', 'cancelled') DEFAULT 'pending',

    -- æ”¯æ‰•ã„æƒ…å ±
    transaction_id VARCHAR(255) COMMENT 'æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ID',
    invoice_number VARCHAR(50) UNIQUE,
    invoice_url VARCHAR(500),

    -- ç¨é‡‘
    tax_amount DECIMAL(15, 2) DEFAULT 0.00,
    withholding_tax DECIMAL(15, 2) DEFAULT 0.00 COMMENT 'æºæ³‰å¾´åç¨',
    net_amount DECIMAL(15, 2) NOT NULL COMMENT 'æ‰‹å–ã‚Šé¡',

    -- æ‰‹æ•°æ–™
    fee_amount DECIMAL(10, 2) DEFAULT 0.00,

    -- å‚™è€ƒ
    notes TEXT,

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    scheduled_at DATE COMMENT 'æ”¯æ‰•ã„äºˆå®šæ—¥',
    paid_at TIMESTAMP NULL COMMENT 'å®Ÿéš›ã®æ”¯æ‰•æ—¥æ™‚',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    INDEX idx_affiliate (affiliate_id, status, scheduled_at),
    INDEX idx_status (status, scheduled_at),
    INDEX idx_period (period_start, period_end),
    INDEX idx_invoice (invoice_number),

    -- å¤–éƒ¨ã‚­ãƒ¼
    FOREIGN KEY (affiliate_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 6. fraud_logs ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¸æ­£æ¤œçŸ¥ãƒ­ã‚°ï¼‰

```sql
CREATE TABLE fraud_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    -- å¯¾è±¡
    entity_type ENUM('click', 'conversion', 'user') NOT NULL,
    entity_id BIGINT UNSIGNED NOT NULL,

    -- æ¤œçŸ¥å†…å®¹
    fraud_type VARCHAR(100) NOT NULL COMMENT 'click_spam, cookie_stuffing, etc.',
    risk_score TINYINT UNSIGNED NOT NULL COMMENT '0-100',
    confidence_level ENUM('low', 'medium', 'high', 'critical') NOT NULL,

    -- è©³ç´°
    detection_rules JSON COMMENT 'æ¤œçŸ¥ãƒ«ãƒ¼ãƒ«è©³ç´°',
    evidence JSON COMMENT 'è¨¼æ‹ ãƒ‡ãƒ¼ã‚¿',

    -- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    action_taken ENUM('flagged', 'blocked', 'manual_review', 'approved') DEFAULT 'flagged',
    reviewed_by BIGINT UNSIGNED,
    reviewed_at TIMESTAMP NULL,

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    detected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    INDEX idx_entity (entity_type, entity_id),
    INDEX idx_fraud_type (fraud_type, detected_at),
    INDEX idx_risk (risk_score, confidence_level),
    INDEX idx_action (action_taken)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 7. audit_logs ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç›£æŸ»ãƒ­ã‚°ï¼‰

```sql
CREATE TABLE audit_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    -- æ“ä½œè€…
    user_id BIGINT UNSIGNED,
    user_type VARCHAR(50),

    -- æ“ä½œå†…å®¹
    action VARCHAR(100) NOT NULL COMMENT 'created, updated, deleted, approved, etc.',
    entity_type VARCHAR(100) NOT NULL COMMENT 'user, campaign, conversion, etc.',
    entity_id BIGINT UNSIGNED,

    -- å¤‰æ›´å†…å®¹
    old_values JSON COMMENT 'å¤‰æ›´å‰ã®å€¤',
    new_values JSON COMMENT 'å¤‰æ›´å¾Œã®å€¤',

    -- ãƒ¡ã‚¿æƒ…å ±
    ip_address VARCHAR(45),
    user_agent TEXT,

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    INDEX idx_user (user_id, created_at),
    INDEX idx_entity (entity_type, entity_id, created_at),
    INDEX idx_action (action, created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
PARTITION BY RANGE (UNIX_TIMESTAMP(created_at)) (
    PARTITION p202401 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-01')),
    PARTITION p202402 VALUES LESS THAN (UNIX_TIMESTAMP('2024-03-01')),
    -- ... æœˆæ¬¡ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

---

### 8. webhooks ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆWebhookç®¡ç†ï¼‰

```sql
CREATE TABLE webhooks (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    uuid CHAR(36) NOT NULL UNIQUE,

    -- æ‰€æœ‰è€…
    user_id BIGINT UNSIGNED NOT NULL,

    -- Webhookè¨­å®š
    name VARCHAR(255) NOT NULL,
    url VARCHAR(2048) NOT NULL,
    secret VARCHAR(255) NOT NULL COMMENT 'ç½²åç”¨ç§˜å¯†éµ',

    -- ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    events JSON NOT NULL COMMENT 'è³¼èª­ã‚¤ãƒ™ãƒ³ãƒˆ ["click.created", "conversion.approved"]',

    -- ãƒªãƒˆãƒ©ã‚¤è¨­å®š
    retry_attempts TINYINT UNSIGNED DEFAULT 3,
    retry_delay_seconds INT UNSIGNED DEFAULT 60,

    -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    is_active BOOLEAN DEFAULT TRUE,
    last_triggered_at TIMESTAMP NULL,
    last_success_at TIMESTAMP NULL,
    last_failure_at TIMESTAMP NULL,
    consecutive_failures TINYINT UNSIGNED DEFAULT 0,

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    INDEX idx_user (user_id, is_active),

    -- å¤–éƒ¨ã‚­ãƒ¼
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE webhook_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    webhook_id BIGINT UNSIGNED NOT NULL,

    -- ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    event_type VARCHAR(100) NOT NULL,
    payload JSON NOT NULL,

    -- ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    status_code SMALLINT UNSIGNED,
    response_body TEXT,
    response_time_ms INT UNSIGNED,

    -- ã‚¨ãƒ©ãƒ¼
    error_message TEXT,

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    INDEX idx_webhook (webhook_id, sent_at),
    INDEX idx_event (event_type, sent_at),

    FOREIGN KEY (webhook_id) REFERENCES webhooks(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## ğŸš€ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

### è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆåŸå‰‡

```sql
-- 1. ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ã®é«˜ã„åˆ—ã‚’å…ˆé ­ã«
-- 2. WHEREå¥ã§é »ç¹ã«ä½¿ç”¨ã•ã‚Œã‚‹åˆ—
-- 3. ORDER BY / GROUP BY åˆ—ã‚’è€ƒæ…®

-- ä¾‹: conversions ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_conversion_reporting ON conversions (
    status,           -- WHERE status = 'approved' (é«˜é »åº¦)
    affiliate_id,     -- WHERE affiliate_id = X (çµã‚Šè¾¼ã¿)
    converted_at      -- ORDER BY converted_at DESC (ã‚½ãƒ¼ãƒˆ)
);

-- ã‚«ãƒãƒªãƒ³ã‚°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚¯ã‚¨ãƒªã«å¿…è¦ãªå…¨åˆ—ã‚’å«ã‚€ï¼‰
CREATE INDEX idx_conversion_summary ON conversions (
    affiliate_id,
    status,
    converted_at,
    commission_amount,
    order_amount
) COMMENT 'ãƒ¬ãƒãƒ¼ãƒˆç”¨ã‚«ãƒãƒªãƒ³ã‚°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹';
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–

```sql
-- ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªãƒ­ã‚°æœ‰åŠ¹åŒ–
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1; -- 1ç§’ä»¥ä¸Šã®ã‚¯ã‚¨ãƒª

-- æœªä½¿ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ç¢ºèª
SELECT
    object_schema AS database_name,
    object_name AS table_name,
    index_name,
    rows_examined,
    rows_sent
FROM performance_schema.table_io_waits_summary_by_index_usage
WHERE index_name IS NOT NULL
  AND index_name != 'PRIMARY'
  AND rows_examined = 0
ORDER BY object_schema, object_name;
```

---

## ğŸ“¦ ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°æˆ¦ç•¥

### æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ç®¡ç†

```sql
-- è‡ªå‹•ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¿½åŠ ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£
DELIMITER $$

CREATE PROCEDURE add_partition_for_next_month()
BEGIN
    DECLARE next_month_start DATE;
    DECLARE next_month_name VARCHAR(20);

    SET next_month_start = DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL 2 MONTH), '%Y-%m-01');
    SET next_month_name = CONCAT('p', DATE_FORMAT(next_month_start, '%Y%m'));

    SET @sql = CONCAT(
        'ALTER TABLE clicks REORGANIZE PARTITION p_future INTO (',
        'PARTITION ', next_month_name,
        ' VALUES LESS THAN (UNIX_TIMESTAMP(''', next_month_start, ''')),',
        'PARTITION p_future VALUES LESS THAN MAXVALUE)'
    );

    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END$$

DELIMITER ;

-- æœˆæ¬¡å®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ï¼‰
CREATE EVENT auto_add_partition
ON SCHEDULE EVERY 1 MONTH
STARTS '2024-01-01 00:00:00'
DO CALL add_partition_for_next_month();

-- å¤ã„ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆ90æ—¥ä»¥å‰ï¼‰
CREATE EVENT cleanup_old_partitions
ON SCHEDULE EVERY 1 WEEK
DO BEGIN
    DECLARE partition_to_drop VARCHAR(20);
    SET partition_to_drop = CONCAT('p', DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 90 DAY), '%Y%m'));

    SET @sql = CONCAT('ALTER TABLE clicks DROP PARTITION IF EXISTS ', partition_to_drop);
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END;
```

---

## ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»

### ãƒ•ã‚§ãƒ¼ã‚º1: æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ç„¡ã—ï¼‰

```sql
-- 1. æ–°ã‚¹ã‚­ãƒ¼ãƒã§ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE users_new LIKE users; -- æ–°å®šç¾©ã§ä½œæˆ

-- 2. åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚³ãƒ”ãƒ¼
INSERT INTO users_new
SELECT * FROM admin
WHERE user_type = 'admin';

INSERT INTO users_new
SELECT * FROM nUser
WHERE user_type = 'affiliate';

-- 3. ãƒˆãƒªã‚¬ãƒ¼ã§ç¶™ç¶šçš„åŒæœŸ
DELIMITER $$

CREATE TRIGGER sync_users_insert AFTER INSERT ON admin
FOR EACH ROW
BEGIN
    INSERT INTO users_new (...) VALUES (...);
END$$

CREATE TRIGGER sync_users_update AFTER UPDATE ON admin
FOR EACH ROW
BEGIN
    UPDATE users_new SET ... WHERE id = NEW.id;
END$$

DELIMITER ;
```

### ãƒ•ã‚§ãƒ¼ã‚º2: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ

```php
// ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ©ã‚¤ãƒˆæœŸé–“ï¼ˆæ–°æ—§ä¸¡æ–¹ã«æ›¸ãè¾¼ã¿ï¼‰
class UserRepository {
    public function create($data) {
        // æ—§ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ›¸ãè¾¼ã¿
        DB::table('admin')->insert($data);

        // æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚‚æ›¸ãè¾¼ã¿
        DB::table('users_new')->insert($data);
    }

    public function find($id) {
        // æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰èª­ã¿å–ã‚Šï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
        $user = DB::table('users_new')->find($id);

        if (!$user) {
            $user = DB::table('admin')->find($id);
        }

        return $user;
    }
}
```

### ãƒ•ã‚§ãƒ¼ã‚º3: ãƒ†ãƒ¼ãƒ–ãƒ«å…¥ã‚Œæ›¿ãˆ

```sql
-- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ä¸­ã«å®Ÿè¡Œ
START TRANSACTION;

-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
CREATE TABLE admin_backup AS SELECT * FROM admin;

-- ãƒ†ãƒ¼ãƒ–ãƒ«åå¤‰æ›´
RENAME TABLE admin TO admin_old;
RENAME TABLE users_new TO users;

COMMIT;

-- æ¤œè¨¼å¾Œã€æ—§ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤
-- DROP TABLE admin_old;
```

---

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ç›®æ¨™

| æ“ä½œ | ç›®æ¨™ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ  | å‚™è€ƒ |
|------|---------------------|------|
| ã‚¯ãƒªãƒƒã‚¯è¨˜éŒ² | < 50ms | éåŒæœŸåŒ–æ¨å¥¨ |
| ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ² | < 100ms | ä¸æ­£æ¤œçŸ¥å«ã‚€ |
| ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º | < 500ms | ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ |
| ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆæœˆæ¬¡ï¼‰ | < 3ç§’ | é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ä½¿ç”¨ |
| æ”¯æ‰•ã„å‡¦ç† | < 200ms | ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ |

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã‚¯ã‚¨ãƒª

```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚µã‚¤ã‚ºç¢ºèª
SELECT
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS size_mb,
    table_rows
FROM information_schema.tables
WHERE table_schema = 'affiliate'
ORDER BY (data_length + index_length) DESC;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŠ¹ç‡ç¢ºèª
EXPLAIN ANALYZE
SELECT * FROM conversions
WHERE affiliate_id = 123
  AND status = 'approved'
  AND converted_at >= '2024-01-01'
ORDER BY converted_at DESC
LIMIT 100;
```

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

```sql
-- å°‚ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
CREATE USER 'affiliate_app'@'%' IDENTIFIED BY 'strong_password_here';

-- æœ€å°æ¨©é™ä»˜ä¸
GRANT SELECT, INSERT, UPDATE ON affiliate.* TO 'affiliate_app'@'%';

-- å±é™ºãªæ“ä½œã¯ç¦æ­¢
REVOKE DROP, TRUNCATE, ALTER ON affiliate.* FROM 'affiliate_app'@'%';

-- èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆãƒ¬ãƒãƒ¼ãƒˆç”¨ï¼‰
CREATE USER 'affiliate_readonly'@'%' IDENTIFIED BY 'readonly_password';
GRANT SELECT ON affiliate.* TO 'affiliate_readonly'@'%';

-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼
CREATE USER 'affiliate_backup'@'localhost' IDENTIFIED BY 'backup_password';
GRANT SELECT, LOCK TABLES ON affiliate.* TO 'affiliate_backup'@'localhost';
```

---

ã“ã®ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆã«ã‚ˆã‚Šã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å…¼ã­å‚™ãˆãŸç¾ä»£çš„ãªASPã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚
