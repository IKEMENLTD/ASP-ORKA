# データベーススキーマ詳細設計（改善版）

## 📋 目次
1. [全体アーキテクチャ](#全体アーキテクチャ)
2. [テーブル定義](#テーブル定義)
3. [インデックス戦略](#インデックス戦略)
4. [パーティショニング戦略](#パーティショニング戦略)
5. [マイグレーション計画](#マイグレーション計画)

---

## 🏗 全体アーキテクチャ

### データベース構成
```
┌─────────────────────────────────────────────────────────┐
│                   Primary Database (MySQL 8.0)          │
│  - InnoDB Engine                                        │
│  - utf8mb4_unicode_ci                                   │
│  - Row Format: DYNAMIC                                  │
└─────────────────────────────────────────────────────────┘
                    ↓ レプリケーション
┌─────────────────────────────────────────────────────────┐
│              Read Replica 1 (読み取り専用)                │
│  - レポート生成用                                         │
│  - 分析クエリ用                                          │
└─────────────────────────────────────────────────────────┘
                    ↓ レプリケーション
┌─────────────────────────────────────────────────────────┐
│              Read Replica 2 (読み取り専用)                │
│  - バックアップ用                                         │
│  - DR (災害復旧)用                                       │
└─────────────────────────────────────────────────────────┘
```

---

## 📊 テーブル定義

### 1. users テーブル（統合ユーザーテーブル）

```sql
CREATE TABLE users (
    -- 主キー
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    uuid CHAR(36) NOT NULL UNIQUE COMMENT 'UUID v4',

    -- ユーザータイプ
    user_type ENUM('admin', 'affiliate', 'advertiser') NOT NULL COMMENT 'ユーザー種別',

    -- 認証情報
    email VARCHAR(255) NOT NULL UNIQUE,
    email_verified_at TIMESTAMP NULL,
    password VARCHAR(255) NOT NULL COMMENT 'bcrypt/argon2ハッシュ',
    password_changed_at TIMESTAMP NULL COMMENT 'パスワード最終変更日時',
    password_expires_at TIMESTAMP NULL COMMENT 'パスワード有効期限',

    -- 2要素認証
    two_factor_secret VARCHAR(255) NULL COMMENT 'TOTP秘密鍵',
    two_factor_recovery_codes TEXT NULL COMMENT 'リカバリーコード（JSON）',
    two_factor_enabled BOOLEAN DEFAULT FALSE,

    -- プロフィール
    username VARCHAR(100) UNIQUE,
    display_name VARCHAR(255),
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    company_name VARCHAR(255),
    phone VARCHAR(20),
    country_code CHAR(2) COMMENT 'ISO 3166-1 alpha-2',
    language_code CHAR(2) DEFAULT 'ja' COMMENT 'ISO 639-1',
    timezone VARCHAR(50) DEFAULT 'Asia/Tokyo',
    avatar_url VARCHAR(500),

    -- アフィリエイト固有情報
    affiliate_code VARCHAR(20) UNIQUE COMMENT '紹介コード',
    referrer_id BIGINT UNSIGNED NULL COMMENT '紹介者ID',
    tier_level TINYINT UNSIGNED DEFAULT 0 COMMENT '階層レベル (0-3)',
    rank_id BIGINT UNSIGNED NULL COMMENT 'ランクID',

    -- 財務情報
    balance DECIMAL(15, 2) DEFAULT 0.00 COMMENT '利用可能残高',
    pending_balance DECIMAL(15, 2) DEFAULT 0.00 COMMENT '保留残高',
    total_earned DECIMAL(15, 2) DEFAULT 0.00 COMMENT '累計報酬',
    total_paid DECIMAL(15, 2) DEFAULT 0.00 COMMENT '累計支払額',
    tier_earnings DECIMAL(15, 2) DEFAULT 0.00 COMMENT 'ティア報酬累計',

    -- KYC (本人確認)
    kyc_status ENUM('none', 'pending', 'approved', 'rejected') DEFAULT 'none',
    kyc_verified_at TIMESTAMP NULL,
    kyc_document_url VARCHAR(500),

    -- ステータス
    status ENUM('active', 'inactive', 'suspended', 'banned') DEFAULT 'active',
    email_notifications BOOLEAN DEFAULT TRUE,
    sms_notifications BOOLEAN DEFAULT FALSE,

    -- セキュリティ
    last_login_at TIMESTAMP NULL,
    last_login_ip VARCHAR(45),
    failed_login_attempts TINYINT UNSIGNED DEFAULT 0,
    locked_until TIMESTAMP NULL,

    -- API
    api_token VARCHAR(80) UNIQUE,
    api_rate_limit INT UNSIGNED DEFAULT 1000 COMMENT '時間当たりリクエスト数',

    -- タイムスタンプ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL COMMENT 'ソフトデリート',

    -- インデックス
    INDEX idx_user_type (user_type, status),
    INDEX idx_email (email),
    INDEX idx_referrer (referrer_id),
    INDEX idx_status (status, created_at),
    INDEX idx_affiliate_code (affiliate_code),
    INDEX idx_created_at (created_at),

    -- 外部キー
    FOREIGN KEY (referrer_id) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (rank_id) REFERENCES ranks(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 2. campaigns テーブル（広告キャンペーン）

```sql
CREATE TABLE campaigns (
    -- 主キー
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    uuid CHAR(36) NOT NULL UNIQUE,

    -- 所有者
    advertiser_id BIGINT UNSIGNED NOT NULL COMMENT '広告主ID',

    -- 基本情報
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) UNIQUE,
    description TEXT,
    category_id BIGINT UNSIGNED,

    -- URL設定
    destination_url VARCHAR(2048) NOT NULL COMMENT '遷移先URL',
    destination_url_mobile VARCHAR(2048) COMMENT 'モバイル用URL',
    tracking_domain VARCHAR(255) COMMENT 'カスタムドメイン',

    -- 報酬設定
    commission_type ENUM('fixed', 'percentage', 'tiered', 'custom') NOT NULL,
    commission_value DECIMAL(10, 2) NOT NULL COMMENT '固定額 or パーセンテージ',
    commission_currency CHAR(3) DEFAULT 'JPY',

    -- クリック報酬
    click_commission DECIMAL(10, 2) DEFAULT 0.00,
    click_enabled BOOLEAN DEFAULT FALSE,

    -- 予算管理
    budget_type ENUM('unlimited', 'daily', 'monthly', 'total', 'conversions') DEFAULT 'unlimited',
    budget_amount DECIMAL(15, 2),
    budget_spent DECIMAL(15, 2) DEFAULT 0.00,

    -- ティア報酬設定
    tier1_rate DECIMAL(5, 2) DEFAULT 0.00 COMMENT '子への報酬率(%)',
    tier2_rate DECIMAL(5, 2) DEFAULT 0.00 COMMENT '孫への報酬率(%)',
    tier3_rate DECIMAL(5, 2) DEFAULT 0.00 COMMENT 'ひ孫への報酬率(%)',

    -- ターゲティング
    geo_targeting JSON COMMENT '地域ターゲティング（国コード配列）',
    device_targeting JSON COMMENT 'デバイスターゲティング',
    time_targeting JSON COMMENT '時間帯ターゲティング',

    -- クリック制限
    click_interval_seconds INT UNSIGNED DEFAULT 3600 COMMENT '重複クリック判定時間',
    conversion_window_hours INT UNSIGNED DEFAULT 720 COMMENT 'コンバージョン有効期間(30日)',

    -- 承認フロー
    auto_approve_conversions BOOLEAN DEFAULT FALSE,
    auto_approve_clicks BOOLEAN DEFAULT TRUE,

    -- 統計情報（非正規化）
    total_clicks BIGINT UNSIGNED DEFAULT 0,
    total_conversions BIGINT UNSIGNED DEFAULT 0,
    total_revenue DECIMAL(15, 2) DEFAULT 0.00,
    conversion_rate DECIMAL(5, 2) DEFAULT 0.00 COMMENT 'CVR(%)',

    -- ステータス
    status ENUM('draft', 'pending', 'active', 'paused', 'completed', 'archived') DEFAULT 'draft',
    visibility ENUM('public', 'private', 'invite_only') DEFAULT 'public',

    -- 掲載期間
    starts_at TIMESTAMP NULL,
    ends_at TIMESTAMP NULL,

    -- タイムスタンプ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,

    -- インデックス
    INDEX idx_advertiser (advertiser_id, status),
    INDEX idx_status (status, visibility),
    INDEX idx_category (category_id),
    INDEX idx_dates (starts_at, ends_at),
    INDEX idx_slug (slug),

    -- 外部キー
    FOREIGN KEY (advertiser_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 3. clicks テーブル（クリックログ - パーティション対応）

```sql
CREATE TABLE clicks (
    -- 主キー
    id BIGINT UNSIGNED AUTO_INCREMENT,
    uuid CHAR(36) NOT NULL,

    -- 関連情報
    campaign_id BIGINT UNSIGNED NOT NULL,
    affiliate_id BIGINT UNSIGNED NOT NULL,

    -- トラッキング情報
    tracking_id VARCHAR(64) UNIQUE COMMENT 'ユニークトラッキングID',

    -- アクセス情報
    ip_address VARCHAR(45) NOT NULL,
    user_agent TEXT,
    referer TEXT,

    -- デバイス情報（パース済み）
    device_type ENUM('desktop', 'mobile', 'tablet', 'bot') DEFAULT 'desktop',
    browser VARCHAR(50),
    os VARCHAR(50),

    -- 地理情報
    country_code CHAR(2),
    region VARCHAR(100),
    city VARCHAR(100),
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),

    -- UTMパラメータ
    utm_source VARCHAR(255),
    utm_medium VARCHAR(255),
    utm_campaign VARCHAR(255),
    utm_term VARCHAR(255),
    utm_content VARCHAR(255),

    -- Cookie/セッション
    cookie_id VARCHAR(64),
    session_id VARCHAR(64),
    fingerprint VARCHAR(64) COMMENT 'デバイスフィンガープリント',

    -- 不正検知
    fraud_score TINYINT UNSIGNED DEFAULT 0 COMMENT '0-100',
    is_suspicious BOOLEAN DEFAULT FALSE,
    fraud_reason VARCHAR(255),

    -- タイムスタンプ
    clicked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 主キー（パーティションキーを含む）
    PRIMARY KEY (id, clicked_at),

    -- インデックス
    INDEX idx_campaign (campaign_id, clicked_at),
    INDEX idx_affiliate (affiliate_id, clicked_at),
    INDEX idx_tracking (tracking_id),
    INDEX idx_cookie (cookie_id),
    INDEX idx_suspicious (is_suspicious, clicked_at)

) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
PARTITION BY RANGE (UNIX_TIMESTAMP(clicked_at)) (
    PARTITION p202401 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-01')),
    PARTITION p202402 VALUES LESS THAN (UNIX_TIMESTAMP('2024-03-01')),
    PARTITION p202403 VALUES LESS THAN (UNIX_TIMESTAMP('2024-04-01')),
    PARTITION p202404 VALUES LESS THAN (UNIX_TIMESTAMP('2024-05-01')),
    PARTITION p202405 VALUES LESS THAN (UNIX_TIMESTAMP('2024-06-01')),
    PARTITION p202406 VALUES LESS THAN (UNIX_TIMESTAMP('2024-07-01')),
    PARTITION p202407 VALUES LESS THAN (UNIX_TIMESTAMP('2024-08-01')),
    PARTITION p202408 VALUES LESS THAN (UNIX_TIMESTAMP('2024-09-01')),
    PARTITION p202409 VALUES LESS THAN (UNIX_TIMESTAMP('2024-10-01')),
    PARTITION p202410 VALUES LESS THAN (UNIX_TIMESTAMP('2024-11-01')),
    PARTITION p202411 VALUES LESS THAN (UNIX_TIMESTAMP('2024-12-01')),
    PARTITION p202412 VALUES LESS THAN (UNIX_TIMESTAMP('2025-01-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- パーティション自動追加スクリプト（月次実行）
-- ALTER TABLE clicks REORGANIZE PARTITION p_future INTO (
--     PARTITION p202501 VALUES LESS THAN (UNIX_TIMESTAMP('2025-02-01')),
--     PARTITION p_future VALUES LESS THAN MAXVALUE
-- );
```

---

### 4. conversions テーブル（コンバージョン）

```sql
CREATE TABLE conversions (
    -- 主キー
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    uuid CHAR(36) NOT NULL UNIQUE,

    -- 関連情報
    campaign_id BIGINT UNSIGNED NOT NULL,
    affiliate_id BIGINT UNSIGNED NOT NULL,
    click_id BIGINT UNSIGNED COMMENT '元クリックID',

    -- トラッキング
    tracking_id VARCHAR(64),
    order_id VARCHAR(100) COMMENT 'EC注文ID',

    -- 金額情報
    order_amount DECIMAL(15, 2) NOT NULL COMMENT '注文金額',
    commission_amount DECIMAL(15, 2) NOT NULL COMMENT '報酬額',
    currency CHAR(3) DEFAULT 'JPY',

    -- 商品情報
    product_id VARCHAR(100),
    product_name VARCHAR(255),
    product_category VARCHAR(100),
    quantity INT UNSIGNED DEFAULT 1,

    -- ステータス
    status ENUM('pending', 'approved', 'rejected', 'cancelled', 'refunded') DEFAULT 'pending',
    approval_status_changed_at TIMESTAMP NULL,
    approved_by BIGINT UNSIGNED COMMENT '承認者ID',
    rejection_reason TEXT,

    -- 顧客情報（ハッシュ化）
    customer_email_hash VARCHAR(64) COMMENT 'SHA256ハッシュ',
    customer_id_hash VARCHAR(64),
    is_new_customer BOOLEAN DEFAULT TRUE,

    -- ティア報酬
    tier1_commission DECIMAL(10, 2) DEFAULT 0.00,
    tier2_commission DECIMAL(10, 2) DEFAULT 0.00,
    tier3_commission DECIMAL(10, 2) DEFAULT 0.00,

    -- 不正検知
    fraud_score TINYINT UNSIGNED DEFAULT 0,
    is_suspicious BOOLEAN DEFAULT FALSE,
    fraud_checks JSON COMMENT '不正検知結果',

    -- メタデータ
    metadata JSON COMMENT 'カスタムデータ',

    -- タイムスタンプ
    converted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- インデックス
    INDEX idx_campaign (campaign_id, status, converted_at),
    INDEX idx_affiliate (affiliate_id, status, converted_at),
    INDEX idx_status (status, converted_at),
    INDEX idx_order (order_id),
    INDEX idx_suspicious (is_suspicious, status),

    -- 外部キー
    FOREIGN KEY (campaign_id) REFERENCES campaigns(id) ON DELETE CASCADE,
    FOREIGN KEY (affiliate_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (approved_by) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 5. payments テーブル（支払い履歴）

```sql
CREATE TABLE payments (
    -- 主キー
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    uuid CHAR(36) NOT NULL UNIQUE,

    -- 関連情報
    affiliate_id BIGINT UNSIGNED NOT NULL,

    -- 金額
    amount DECIMAL(15, 2) NOT NULL,
    currency CHAR(3) DEFAULT 'JPY',

    -- 支払い方法
    payment_method ENUM('bank_transfer', 'paypal', 'stripe', 'crypto', 'other') NOT NULL,
    payment_method_details JSON COMMENT '支払先情報（暗号化）',

    -- 対象期間
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,

    -- ステータス
    status ENUM('pending', 'processing', 'completed', 'failed', 'cancelled') DEFAULT 'pending',

    -- 支払い情報
    transaction_id VARCHAR(255) COMMENT '決済システムのトランザクションID',
    invoice_number VARCHAR(50) UNIQUE,
    invoice_url VARCHAR(500),

    -- 税金
    tax_amount DECIMAL(15, 2) DEFAULT 0.00,
    withholding_tax DECIMAL(15, 2) DEFAULT 0.00 COMMENT '源泉徴収税',
    net_amount DECIMAL(15, 2) NOT NULL COMMENT '手取り額',

    -- 手数料
    fee_amount DECIMAL(10, 2) DEFAULT 0.00,

    -- 備考
    notes TEXT,

    -- タイムスタンプ
    scheduled_at DATE COMMENT '支払い予定日',
    paid_at TIMESTAMP NULL COMMENT '実際の支払日時',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- インデックス
    INDEX idx_affiliate (affiliate_id, status, scheduled_at),
    INDEX idx_status (status, scheduled_at),
    INDEX idx_period (period_start, period_end),
    INDEX idx_invoice (invoice_number),

    -- 外部キー
    FOREIGN KEY (affiliate_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 6. fraud_logs テーブル（不正検知ログ）

```sql
CREATE TABLE fraud_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    -- 対象
    entity_type ENUM('click', 'conversion', 'user') NOT NULL,
    entity_id BIGINT UNSIGNED NOT NULL,

    -- 検知内容
    fraud_type VARCHAR(100) NOT NULL COMMENT 'click_spam, cookie_stuffing, etc.',
    risk_score TINYINT UNSIGNED NOT NULL COMMENT '0-100',
    confidence_level ENUM('low', 'medium', 'high', 'critical') NOT NULL,

    -- 詳細
    detection_rules JSON COMMENT '検知ルール詳細',
    evidence JSON COMMENT '証拠データ',

    -- アクション
    action_taken ENUM('flagged', 'blocked', 'manual_review', 'approved') DEFAULT 'flagged',
    reviewed_by BIGINT UNSIGNED,
    reviewed_at TIMESTAMP NULL,

    -- タイムスタンプ
    detected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- インデックス
    INDEX idx_entity (entity_type, entity_id),
    INDEX idx_fraud_type (fraud_type, detected_at),
    INDEX idx_risk (risk_score, confidence_level),
    INDEX idx_action (action_taken)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 7. audit_logs テーブル（監査ログ）

```sql
CREATE TABLE audit_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    -- 操作者
    user_id BIGINT UNSIGNED,
    user_type VARCHAR(50),

    -- 操作内容
    action VARCHAR(100) NOT NULL COMMENT 'created, updated, deleted, approved, etc.',
    entity_type VARCHAR(100) NOT NULL COMMENT 'user, campaign, conversion, etc.',
    entity_id BIGINT UNSIGNED,

    -- 変更内容
    old_values JSON COMMENT '変更前の値',
    new_values JSON COMMENT '変更後の値',

    -- メタ情報
    ip_address VARCHAR(45),
    user_agent TEXT,

    -- タイムスタンプ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- インデックス
    INDEX idx_user (user_id, created_at),
    INDEX idx_entity (entity_type, entity_id, created_at),
    INDEX idx_action (action, created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
PARTITION BY RANGE (UNIX_TIMESTAMP(created_at)) (
    PARTITION p202401 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-01')),
    PARTITION p202402 VALUES LESS THAN (UNIX_TIMESTAMP('2024-03-01')),
    -- ... 月次パーティション
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

---

### 8. webhooks テーブル（Webhook管理）

```sql
CREATE TABLE webhooks (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    uuid CHAR(36) NOT NULL UNIQUE,

    -- 所有者
    user_id BIGINT UNSIGNED NOT NULL,

    -- Webhook設定
    name VARCHAR(255) NOT NULL,
    url VARCHAR(2048) NOT NULL,
    secret VARCHAR(255) NOT NULL COMMENT '署名用秘密鍵',

    -- イベント設定
    events JSON NOT NULL COMMENT '購読イベント ["click.created", "conversion.approved"]',

    -- リトライ設定
    retry_attempts TINYINT UNSIGNED DEFAULT 3,
    retry_delay_seconds INT UNSIGNED DEFAULT 60,

    -- ステータス
    is_active BOOLEAN DEFAULT TRUE,
    last_triggered_at TIMESTAMP NULL,
    last_success_at TIMESTAMP NULL,
    last_failure_at TIMESTAMP NULL,
    consecutive_failures TINYINT UNSIGNED DEFAULT 0,

    -- タイムスタンプ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- インデックス
    INDEX idx_user (user_id, is_active),

    -- 外部キー
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE webhook_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    webhook_id BIGINT UNSIGNED NOT NULL,

    -- リクエスト
    event_type VARCHAR(100) NOT NULL,
    payload JSON NOT NULL,

    -- レスポンス
    status_code SMALLINT UNSIGNED,
    response_body TEXT,
    response_time_ms INT UNSIGNED,

    -- エラー
    error_message TEXT,

    -- タイムスタンプ
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- インデックス
    INDEX idx_webhook (webhook_id, sent_at),
    INDEX idx_event (event_type, sent_at),

    FOREIGN KEY (webhook_id) REFERENCES webhooks(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## 🚀 インデックス戦略

### 複合インデックス設計原則

```sql
-- 1. カーディナリティの高い列を先頭に
-- 2. WHERE句で頻繁に使用される列
-- 3. ORDER BY / GROUP BY 列を考慮

-- 例: conversions テーブル
CREATE INDEX idx_conversion_reporting ON conversions (
    status,           -- WHERE status = 'approved' (高頻度)
    affiliate_id,     -- WHERE affiliate_id = X (絞り込み)
    converted_at      -- ORDER BY converted_at DESC (ソート)
);

-- カバリングインデックス（クエリに必要な全列を含む）
CREATE INDEX idx_conversion_summary ON conversions (
    affiliate_id,
    status,
    converted_at,
    commission_amount,
    order_amount
) COMMENT 'レポート用カバリングインデックス';
```

### パフォーマンス監視

```sql
-- スロークエリログ有効化
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1; -- 1秒以上のクエリ

-- 未使用インデックスの確認
SELECT
    object_schema AS database_name,
    object_name AS table_name,
    index_name,
    rows_examined,
    rows_sent
FROM performance_schema.table_io_waits_summary_by_index_usage
WHERE index_name IS NOT NULL
  AND index_name != 'PRIMARY'
  AND rows_examined = 0
ORDER BY object_schema, object_name;
```

---

## 📦 パーティショニング戦略

### 時系列データのパーティション管理

```sql
-- 自動パーティション追加プロシージャ
DELIMITER $$

CREATE PROCEDURE add_partition_for_next_month()
BEGIN
    DECLARE next_month_start DATE;
    DECLARE next_month_name VARCHAR(20);

    SET next_month_start = DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL 2 MONTH), '%Y-%m-01');
    SET next_month_name = CONCAT('p', DATE_FORMAT(next_month_start, '%Y%m'));

    SET @sql = CONCAT(
        'ALTER TABLE clicks REORGANIZE PARTITION p_future INTO (',
        'PARTITION ', next_month_name,
        ' VALUES LESS THAN (UNIX_TIMESTAMP(''', next_month_start, ''')),',
        'PARTITION p_future VALUES LESS THAN MAXVALUE)'
    );

    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END$$

DELIMITER ;

-- 月次実行スケジュール（イベントスケジューラ）
CREATE EVENT auto_add_partition
ON SCHEDULE EVERY 1 MONTH
STARTS '2024-01-01 00:00:00'
DO CALL add_partition_for_next_month();

-- 古いパーティション削除（90日以前）
CREATE EVENT cleanup_old_partitions
ON SCHEDULE EVERY 1 WEEK
DO BEGIN
    DECLARE partition_to_drop VARCHAR(20);
    SET partition_to_drop = CONCAT('p', DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 90 DAY), '%Y%m'));

    SET @sql = CONCAT('ALTER TABLE clicks DROP PARTITION IF EXISTS ', partition_to_drop);
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END;
```

---

## 🔄 マイグレーション計画

### フェーズ1: 新テーブル作成（ダウンタイム無し）

```sql
-- 1. 新スキーマでテーブル作成
CREATE TABLE users_new LIKE users; -- 新定義で作成

-- 2. 初期データコピー
INSERT INTO users_new
SELECT * FROM admin
WHERE user_type = 'admin';

INSERT INTO users_new
SELECT * FROM nUser
WHERE user_type = 'affiliate';

-- 3. トリガーで継続的同期
DELIMITER $$

CREATE TRIGGER sync_users_insert AFTER INSERT ON admin
FOR EACH ROW
BEGIN
    INSERT INTO users_new (...) VALUES (...);
END$$

CREATE TRIGGER sync_users_update AFTER UPDATE ON admin
FOR EACH ROW
BEGIN
    UPDATE users_new SET ... WHERE id = NEW.id;
END$$

DELIMITER ;
```

### フェーズ2: アプリケーション切り替え

```php
// デュアルライト期間（新旧両方に書き込み）
class UserRepository {
    public function create($data) {
        // 旧テーブルに書き込み
        DB::table('admin')->insert($data);

        // 新テーブルにも書き込み
        DB::table('users_new')->insert($data);
    }

    public function find($id) {
        // 新テーブルから読み取り（フォールバック付き）
        $user = DB::table('users_new')->find($id);

        if (!$user) {
            $user = DB::table('admin')->find($id);
        }

        return $user;
    }
}
```

### フェーズ3: テーブル入れ替え

```sql
-- メンテナンスモード中に実行
START TRANSACTION;

-- バックアップ
CREATE TABLE admin_backup AS SELECT * FROM admin;

-- テーブル名変更
RENAME TABLE admin TO admin_old;
RENAME TABLE users_new TO users;

COMMIT;

-- 検証後、旧テーブル削除
-- DROP TABLE admin_old;
```

---

## 📈 パフォーマンスベンチマーク目標

| 操作 | 目標レスポンスタイム | 備考 |
|------|---------------------|------|
| クリック記録 | < 50ms | 非同期化推奨 |
| コンバージョン記録 | < 100ms | 不正検知含む |
| ダッシュボード表示 | < 500ms | キャッシュ活用 |
| レポート生成（月次） | < 3秒 | 集計テーブル使用 |
| 支払い処理 | < 200ms | トランザクション |

### パフォーマンス監視クエリ

```sql
-- テーブルサイズ確認
SELECT
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS size_mb,
    table_rows
FROM information_schema.tables
WHERE table_schema = 'affiliate'
ORDER BY (data_length + index_length) DESC;

-- インデックス効率確認
EXPLAIN ANALYZE
SELECT * FROM conversions
WHERE affiliate_id = 123
  AND status = 'approved'
  AND converted_at >= '2024-01-01'
ORDER BY converted_at DESC
LIMIT 100;
```

---

## 🔒 セキュリティ設定

```sql
-- 専用データベースユーザー作成
CREATE USER 'affiliate_app'@'%' IDENTIFIED BY 'strong_password_here';

-- 最小権限付与
GRANT SELECT, INSERT, UPDATE ON affiliate.* TO 'affiliate_app'@'%';

-- 危険な操作は禁止
REVOKE DROP, TRUNCATE, ALTER ON affiliate.* FROM 'affiliate_app'@'%';

-- 読み取り専用ユーザー（レポート用）
CREATE USER 'affiliate_readonly'@'%' IDENTIFIED BY 'readonly_password';
GRANT SELECT ON affiliate.* TO 'affiliate_readonly'@'%';

-- バックアップ用ユーザー
CREATE USER 'affiliate_backup'@'localhost' IDENTIFIED BY 'backup_password';
GRANT SELECT, LOCK TABLES ON affiliate.* TO 'affiliate_backup'@'localhost';
```

---

このスキーマ設計により、スケーラビリティ、パフォーマンス、セキュリティを兼ね備えた現代的なASPシステムを構築できます。
