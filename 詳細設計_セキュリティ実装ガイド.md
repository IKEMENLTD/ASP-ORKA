# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…ã‚¬ã‚¤ãƒ‰

## ğŸ“‹ ç›®æ¬¡
1. [èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ](#èªè¨¼ã‚·ã‚¹ãƒ†ãƒ )
2. [æš—å·åŒ–å®Ÿè£…](#æš—å·åŒ–å®Ÿè£…)
3. [ã‚»ã‚­ãƒ¥ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°](#ã‚»ã‚­ãƒ¥ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°)
4. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼)
5. [ç›£æŸ»ãƒ»ãƒ­ã‚°](#ç›£æŸ»ãƒ­ã‚°)

---

## ğŸ” èªè¨¼ã‚·ã‚¹ãƒ†ãƒ 

### 1. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†

#### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆArgon2idï¼‰

```php
<?php
// app/Services/Auth/PasswordService.php

class PasswordService
{
    /**
     * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆï¼ˆArgon2idæ¨å¥¨ï¼‰
     */
    public function hash(string $password): string
    {
        // PHP 7.2+
        return password_hash($password, PASSWORD_ARGON2ID, [
            'memory_cost' => 65536,  // 64MB
            'time_cost' => 4,        // 4åå¾©
            'threads' => 2           // 2ã‚¹ãƒ¬ãƒƒãƒ‰
        ]);

        // PHP 7.2æœªæº€ã®å ´åˆã¯bcrypt
        // return password_hash($password, PASSWORD_BCRYPT, ['cost' => 12]);
    }

    /**
     * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
     */
    public function verify(string $password, string $hash): bool
    {
        return password_verify($password, $hash);
    }

    /**
     * ãƒªãƒãƒƒã‚·ãƒ¥ãŒå¿…è¦ã‹ç¢ºèª
     */
    public function needsRehash(string $hash): bool
    {
        return password_needs_rehash($hash, PASSWORD_ARGON2ID, [
            'memory_cost' => 65536,
            'time_cost' => 4,
            'threads' => 2
        ]);
    }

    /**
     * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦æ¤œè¨¼
     */
    public function validateStrength(string $password): array
    {
        $errors = [];

        if (strlen($password) < 12) {
            $errors[] = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯12æ–‡å­—ä»¥ä¸Šå¿…è¦ã§ã™';
        }

        if (!preg_match('/[a-z]/', $password)) {
            $errors[] = 'å°æ–‡å­—ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™';
        }

        if (!preg_match('/[A-Z]/', $password)) {
            $errors[] = 'å¤§æ–‡å­—ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™';
        }

        if (!preg_match('/[0-9]/', $password)) {
            $errors[] = 'æ•°å­—ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™';
        }

        if (!preg_match('/[^a-zA-Z0-9]/', $password)) {
            $errors[] = 'è¨˜å·ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™';
        }

        // ä¸€èˆ¬çš„ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
        if ($this->isCommonPassword($password)) {
            $errors[] = 'ã‚ˆãä½¿ã‚ã‚Œã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“';
        }

        return [
            'valid' => empty($errors),
            'errors' => $errors,
            'strength' => $this->calculateStrength($password)
        ];
    }

    /**
     * ä¸€èˆ¬çš„ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
     */
    private function isCommonPassword(string $password): bool
    {
        $commonPasswords = [
            'password', 'password123', '123456', 'qwerty',
            'admin', 'letmein', 'welcome', 'monkey'
        ];

        return in_array(strtolower($password), $commonPasswords);
    }

    /**
     * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ã‚¹ã‚³ã‚¢è¨ˆç®—
     */
    private function calculateStrength(string $password): int
    {
        $score = 0;

        $score += min(strlen($password) * 4, 40);
        $score += preg_match('/[a-z]/', $password) ? 10 : 0;
        $score += preg_match('/[A-Z]/', $password) ? 10 : 0;
        $score += preg_match('/[0-9]/', $password) ? 10 : 0;
        $score += preg_match('/[^a-zA-Z0-9]/', $password) ? 20 : 0;

        return min($score, 100);
    }
}
```

---

### 2. äºŒè¦ç´ èªè¨¼ï¼ˆ2FAï¼‰

```php
<?php
// app/Services/Auth/TwoFactorService.php

use OTPHP\TOTP;
use BaconQrCode\Renderer\ImageRenderer;
use BaconQrCode\Renderer\Image\SvgImageBackEnd;
use BaconQrCode\Renderer\RendererStyle\RendererStyle;
use BaconQrCode\Writer;

class TwoFactorService
{
    /**
     * 2FAç§˜å¯†éµç”Ÿæˆ
     */
    public function generateSecret(string $email): array
    {
        $totp = TOTP::create();
        $totp->setLabel($email);
        $totp->setIssuer(config('app.name'));

        return [
            'secret' => $totp->getSecret(),
            'qr_code' => $this->generateQRCode($totp->getProvisioningUri()),
            'backup_codes' => $this->generateBackupCodes()
        ];
    }

    /**
     * QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
     */
    private function generateQRCode(string $uri): string
    {
        $renderer = new ImageRenderer(
            new RendererStyle(300),
            new SvgImageBackEnd()
        );

        $writer = new Writer($renderer);
        return $writer->writeString($uri);
    }

    /**
     * ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
     */
    private function generateBackupCodes(int $count = 8): array
    {
        $codes = [];

        for ($i = 0; $i < $count; $i++) {
            $codes[] = strtoupper(bin2hex(random_bytes(4)));
        }

        return $codes;
    }

    /**
     * TOTPã‚³ãƒ¼ãƒ‰æ¤œè¨¼
     */
    public function verify(string $secret, string $code): bool
    {
        $totp = TOTP::create($secret);

        // å‰å¾Œ30ç§’ã®èª¤å·®ã‚’è¨±å®¹
        return $totp->verify($code, null, 1);
    }

    /**
     * ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰æ¤œè¨¼
     */
    public function verifyBackupCode(User $user, string $code): bool
    {
        $backupCodes = json_decode($user->two_factor_recovery_codes, true);

        if (in_array($code, $backupCodes)) {
            // ä½¿ç”¨æ¸ˆã¿ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
            $backupCodes = array_diff($backupCodes, [$code]);
            $user->two_factor_recovery_codes = json_encode(array_values($backupCodes));
            $user->save();

            return true;
        }

        return false;
    }
}
```

---

### 3. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ

```php
<?php
// app/Services/Auth/LoginThrottleService.php

class LoginThrottleService
{
    private $redis;
    private $maxAttempts = 5;
    private $decayMinutes = 30;

    /**
     * ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
     */
    public function incrementAttempts(string $email): void
    {
        $key = $this->throttleKey($email);
        $attempts = (int) $this->redis->get($key);

        $this->redis->setex($key, $this->decayMinutes * 60, $attempts + 1);
    }

    /**
     * ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ç¢ºèª
     */
    public function isLockedOut(string $email): bool
    {
        return $this->attempts($email) >= $this->maxAttempts;
    }

    /**
     * è©¦è¡Œå›æ•°å–å¾—
     */
    public function attempts(string $email): int
    {
        return (int) $this->redis->get($this->throttleKey($email));
    }

    /**
     * ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆè§£é™¤ã¾ã§ã®æ®‹ã‚Šæ™‚é–“ï¼ˆç§’ï¼‰
     */
    public function availableIn(string $email): int
    {
        return $this->redis->ttl($this->throttleKey($email));
    }

    /**
     * è©¦è¡Œå›æ•°ãƒªã‚»ãƒƒãƒˆ
     */
    public function clearAttempts(string $email): void
    {
        $this->redis->del($this->throttleKey($email));
    }

    /**
     * Redisã‚­ãƒ¼ç”Ÿæˆ
     */
    private function throttleKey(string $email): string
    {
        return 'login_throttle:' . hash('sha256', $email);
    }

    /**
     * IPãƒ™ãƒ¼ã‚¹ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™
     */
    public function checkIPRateLimit(string $ip): bool
    {
        $key = 'ip_login_throttle:' . $ip;
        $attempts = (int) $this->redis->get($key);

        if ($attempts >= 20) { // IPå˜ä½ã§1æ™‚é–“ã«20å›ã¾ã§
            return false;
        }

        $this->redis->setex($key, 3600, $attempts + 1);
        return true;
    }
}
```

---

## ğŸ”’ æš—å·åŒ–å®Ÿè£…

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æš—å·åŒ–

```php
<?php
// app/Services/Encryption/FieldEncryption.php

use Illuminate\Support\Facades\Crypt;

class FieldEncryption
{
    /**
     * ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æš—å·åŒ–ï¼ˆAES-256-GCMï¼‰
     */
    public function encrypt($value): string
    {
        if (is_null($value)) {
            return null;
        }

        return Crypt::encrypt($value);
    }

    /**
     * ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¾©å·åŒ–
     */
    public function decrypt($value)
    {
        if (is_null($value)) {
            return null;
        }

        try {
            return Crypt::decrypt($value);
        } catch (DecryptException $e) {
            // å¾©å·åŒ–å¤±æ•—æ™‚ã®å‡¦ç†
            Log::error('Decryption failed', ['error' => $e->getMessage()]);
            return null;
        }
    }
}

// Eloquent ãƒ¢ãƒ‡ãƒ«ã§ã®ä½¿ç”¨
class User extends Model
{
    /**
     * è‡ªå‹•æš—å·åŒ–ã™ã‚‹ã‚«ãƒ©ãƒ 
     */
    protected $encrypted = [
        'ssn',              // ç¤¾ä¼šä¿éšœç•ªå·
        'bank_account',     // éŠ€è¡Œå£åº§
        'tax_id',           // ç´ç¨è€…ç•ªå·
    ];

    /**
     * ã‚¢ã‚¯ã‚»ã‚µï¼ˆå–å¾—æ™‚ã«å¾©å·åŒ–ï¼‰
     */
    public function getSsnAttribute($value)
    {
        return app(FieldEncryption::class)->decrypt($value);
    }

    /**
     * ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚¿ï¼ˆä¿å­˜æ™‚ã«æš—å·åŒ–ï¼‰
     */
    public function setSsnAttribute($value)
    {
        $this->attributes['ssn'] = app(FieldEncryption::class)->encrypt($value);
    }
}
```

---

### 2. ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆã‚»ã‚­ãƒ¥ã‚¢ãƒ©ãƒ³ãƒ€ãƒ ï¼‰

```php
<?php
// app/Services/Token/TokenGenerator.php

class TokenGenerator
{
    /**
     * ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ©ãƒ³ãƒ€ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
     */
    public function generate(int $length = 32): string
    {
        return bin2hex(random_bytes($length));
    }

    /**
     * API ã‚­ãƒ¼ç”Ÿæˆï¼ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ãï¼‰
     */
    public function generateApiKey(string $prefix = 'sk_live'): string
    {
        $randomPart = $this->generate(32);
        return "{$prefix}_{$randomPart}";
    }

    /**
     * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
     */
    public function generatePasswordResetToken(User $user): string
    {
        $token = $this->generate(32);

        DB::table('password_resets')->insert([
            'email' => $user->email,
            'token' => hash('sha256', $token), // ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ä¿å­˜
            'created_at' => now()
        ]);

        return $token; // å¹³æ–‡ã‚’ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    }

    /**
     * CSRF ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
     */
    public function generateCsrfToken(): string
    {
        if (empty($_SESSION['csrf_token'])) {
            $_SESSION['csrf_token'] = $this->generate(32);
        }

        return $_SESSION['csrf_token'];
    }

    /**
     * CSRF ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
     */
    public function verifyCsrfToken(string $token): bool
    {
        if (empty($_SESSION['csrf_token'])) {
            return false;
        }

        return hash_equals($_SESSION['csrf_token'], $token);
    }
}
```

---

## ğŸ›¡ ã‚»ã‚­ãƒ¥ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

### 1. SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–

```php
<?php
// âŒ å±é™ºï¼ˆè„†å¼±ï¼‰
$userId = $_GET['id'];
$query = "SELECT * FROM users WHERE id = " . $userId;
$result = mysqli_query($conn, $query);

// âœ… å®‰å…¨ï¼ˆãƒ—ãƒªãƒšã‚¢ãƒ‰ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆï¼‰
$userId = $_GET['id'];
$stmt = $pdo->prepare('SELECT * FROM users WHERE id = :id');
$stmt->execute(['id' => $userId]);
$result = $stmt->fetch();

// âœ… Laravelï¼ˆEloquent ORMï¼‰
$user = User::find($userId);

// âœ… ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼
$users = DB::table('users')
    ->where('status', '=', $status)
    ->orderBy('created_at', 'desc')
    ->get();
```

---

### 2. XSS å¯¾ç­–

```php
<?php
// âŒ å±é™º
echo $_GET['name'];
echo "<div>" . $userInput . "</div>";

// âœ… å®‰å…¨ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
echo htmlspecialchars($_GET['name'], ENT_QUOTES, 'UTF-8');

// âœ… Laravel Bladeï¼ˆè‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
{{ $userInput }}  // è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
{!! $trustedHtml !!}  // æ‰‹å‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆä¿¡é ¼ã§ãã‚‹HTMLã®ã¿ï¼‰

// JavaScriptå†…ã§ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
<script>
var userName = <?= json_encode($userName, JSON_HEX_TAG | JSON_HEX_AMP) ?>;
</script>
```

---

### 3. CSRF å¯¾ç­–

```php
<?php
// ãƒ•ã‚©ãƒ¼ãƒ ã«CSRFãƒˆãƒ¼ã‚¯ãƒ³åŸ‹ã‚è¾¼ã¿
<form method="POST" action="/api/campaigns">
    <input type="hidden" name="_token" value="<?= csrf_token() ?>">
    <!-- ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
</form>

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§æ¤œè¨¼
class VerifyCsrfToken
{
    public function handle($request, Closure $next)
    {
        if ($this->isReading($request) || $this->tokensMatch($request)) {
            return $next($request);
        }

        throw new TokenMismatchException('CSRF token mismatch');
    }

    protected function tokensMatch($request)
    {
        $token = $request->input('_token') ?: $request->header('X-CSRF-TOKEN');

        return hash_equals(
            $request->session()->token(),
            $token
        );
    }
}
```

---

### 4. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

```php
<?php
// app/Services/Upload/SecureFileUpload.php

class SecureFileUpload
{
    private $allowedMimes = [
        'image/jpeg',
        'image/png',
        'image/gif',
        'image/webp',
        'application/pdf'
    ];

    private $maxFileSize = 5 * 1024 * 1024; // 5MB

    /**
     * ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
     */
    public function upload(UploadedFile $file): array
    {
        // 1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
        if ($file->getSize() > $this->maxFileSize) {
            throw new ValidationException('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™');
        }

        // 2. MIME ã‚¿ã‚¤ãƒ—æ¤œè¨¼
        $finfo = finfo_open(FILEINFO_MIME_TYPE);
        $mimeType = finfo_file($finfo, $file->getPathname());
        finfo_close($finfo);

        if (!in_array($mimeType, $this->allowedMimes)) {
            throw new ValidationException('è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™');
        }

        // 3. æ‹¡å¼µå­æ¤œè¨¼
        $extension = $file->getClientOriginalExtension();
        if (!$this->isAllowedExtension($extension, $mimeType)) {
            throw new ValidationException('æ‹¡å¼µå­ã¨MIMEã‚¿ã‚¤ãƒ—ãŒä¸€è‡´ã—ã¾ã›ã‚“');
        }

        // 4. ãƒ•ã‚¡ã‚¤ãƒ«åã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
        $originalName = $this->sanitizeFilename($file->getClientOriginalName());

        // 5. ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
        $filename = bin2hex(random_bytes(16)) . '.' . $extension;

        // 6. ã‚¦ã‚¤ãƒ«ã‚¹ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆClamAVç­‰ï¼‰
        if ($this->hasVirus($file->getPathname())) {
            throw new SecurityException('ã‚¦ã‚¤ãƒ«ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ');
        }

        // 7. ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼ˆå…¬é–‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå¤–ï¼‰
        $path = storage_path('app/uploads/' . date('Y/m/d'));

        if (!file_exists($path)) {
            mkdir($path, 0755, true);
        }

        $file->move($path, $filename);

        // 8. ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨­å®š
        chmod($path . '/' . $filename, 0644);

        return [
            'filename' => $filename,
            'original_name' => $originalName,
            'path' => $path . '/' . $filename,
            'mime_type' => $mimeType,
            'size' => $file->getSize()
        ];
    }

    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«åã‚µãƒ‹ã‚¿ã‚¤ã‚º
     */
    private function sanitizeFilename(string $filename): string
    {
        // å±é™ºãªæ–‡å­—ã‚’é™¤å»
        $filename = preg_replace('/[^a-zA-Z0-9._-]/', '_', $filename);

        // ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«é˜²æ­¢
        $filename = str_replace(['..', '/', '\\'], '', $filename);

        return substr($filename, 0, 255);
    }

    /**
     * ã‚¦ã‚¤ãƒ«ã‚¹ã‚¹ã‚­ãƒ£ãƒ³
     */
    private function hasVirus(string $filepath): bool
    {
        // ClamAVä½¿ç”¨ä¾‹
        $clamscan = '/usr/bin/clamscan';

        if (file_exists($clamscan)) {
            exec("$clamscan --no-summary $filepath", $output, $returnCode);
            return $returnCode !== 0;
        }

        return false;
    }
}
```

---

## ğŸŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼

### 1. æ¨å¥¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š

```php
<?php
// app/Http/Middleware/SecurityHeaders.php

class SecurityHeaders
{
    public function handle($request, Closure $next)
    {
        $response = $next($request);

        // Content Security Policy
        $response->headers->set('Content-Security-Policy',
            "default-src 'self'; " .
            "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.example.com; " .
            "style-src 'self' 'unsafe-inline' https://cdn.example.com; " .
            "img-src 'self' data: https:; " .
            "font-src 'self' data: https://cdn.example.com; " .
            "connect-src 'self' https://api.example.com; " .
            "frame-ancestors 'none'; " .
            "base-uri 'self'; " .
            "form-action 'self'"
        );

        // X-Frame-Optionsï¼ˆã‚¯ãƒªãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°å¯¾ç­–ï¼‰
        $response->headers->set('X-Frame-Options', 'DENY');

        // X-Content-Type-Optionsï¼ˆMIMEã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°é˜²æ­¢ï¼‰
        $response->headers->set('X-Content-Type-Options', 'nosniff');

        // X-XSS-Protection
        $response->headers->set('X-XSS-Protection', '1; mode=block');

        // Strict-Transport-Securityï¼ˆHSTSï¼‰
        $response->headers->set('Strict-Transport-Security',
            'max-age=31536000; includeSubDomains; preload'
        );

        // Referrer-Policy
        $response->headers->set('Referrer-Policy', 'strict-origin-when-cross-origin');

        // Permissions-Policyï¼ˆæ—§ Feature-Policyï¼‰
        $response->headers->set('Permissions-Policy',
            'geolocation=(), microphone=(), camera=()'
        );

        return $response;
    }
}
```

---

## ğŸ“ ç›£æŸ»ãƒ»ãƒ­ã‚°

### 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¨˜éŒ²

```php
<?php
// app/Services/Audit/AuditLogger.php

class AuditLogger
{
    /**
     * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²
     */
    public function logSecurityEvent(string $event, array $data = []): void
    {
        Log::channel('security')->info($event, array_merge($data, [
            'user_id' => auth()->id(),
            'ip' => request()->ip(),
            'user_agent' => request()->userAgent(),
            'timestamp' => now()->toIso8601String(),
            'request_id' => request()->header('X-Request-ID')
        ]));
    }

    /**
     * ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸãƒ­ã‚°
     */
    public function logLoginSuccess(User $user): void
    {
        $this->logSecurityEvent('LOGIN_SUCCESS', [
            'user_id' => $user->id,
            'email' => $user->email,
            'two_factor_used' => $user->two_factor_enabled
        ]);
    }

    /**
     * ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ãƒ­ã‚°
     */
    public function logLoginFailed(string $email, string $reason): void
    {
        $this->logSecurityEvent('LOGIN_FAILED', [
            'email' => $email,
            'reason' => $reason,
            'attempts' => $this->getFailedAttempts($email)
        ]);
    }

    /**
     * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ­ã‚°
     */
    public function logPasswordChanged(User $user): void
    {
        $this->logSecurityEvent('PASSWORD_CHANGED', [
            'user_id' => $user->id
        ]);

        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        Mail::to($user)->send(new PasswordChangedNotification());
    }

    /**
     * ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œãƒ­ã‚°
     */
    public function logUnauthorizedAccess(string $resource, string $action): void
    {
        $this->logSecurityEvent('UNAUTHORIZED_ACCESS', [
            'resource' => $resource,
            'action' => $action,
            'severity' => 'HIGH'
        ]);

        // é‡è¦åº¦ãŒé«˜ã„å ´åˆã¯å³åº§ã«é€šçŸ¥
        $this->sendSecurityAlert('ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ');
    }

    /**
     * ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ç›£æŸ»ãƒ­ã‚°
     */
    public function logDataChange(string $model, $id, array $changes): void
    {
        DB::table('audit_logs')->insert([
            'user_id' => auth()->id(),
            'action' => 'UPDATE',
            'entity_type' => $model,
            'entity_id' => $id,
            'old_values' => json_encode($changes['old']),
            'new_values' => json_encode($changes['new']),
            'ip_address' => request()->ip(),
            'user_agent' => request()->userAgent(),
            'created_at' => now()
        ]);
    }
}

// Eloquent ãƒ¢ãƒ‡ãƒ«ã§ã®è‡ªå‹•ç›£æŸ»ãƒ­ã‚°
class Campaign extends Model
{
    use Auditable;

    protected static function boot()
    {
        parent::boot();

        static::updated(function ($model) {
            app(AuditLogger::class)->logDataChange(
                'Campaign',
                $model->id,
                [
                    'old' => $model->getOriginal(),
                    'new' => $model->getAttributes()
                ]
            );
        });
    }
}
```

---

### 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è„…å¨æ¤œçŸ¥

```php
<?php
// app/Services/Security/ThreatDetector.php

class ThreatDetector
{
    /**
     * ç•°å¸¸ãªã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œçŸ¥
     */
    public function detectAnomalousActivity(User $user): bool
    {
        // 1. åœ°ç†çš„ç•°å¸¸ï¼ˆé€šå¸¸ã¨ç•°ãªã‚‹å ´æ‰€ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼‰
        if ($this->detectGeoAnomaly($user)) {
            $this->sendSecurityAlert($user, 'GEO_ANOMALY');
            return true;
        }

        // 2. ãƒ‡ãƒã‚¤ã‚¹å¤‰æ›´æ¤œçŸ¥
        if ($this->detectNewDevice($user)) {
            $this->requireAdditionalVerification($user);
        }

        // 3. çŸ­æ™‚é–“ã§ã®å¤§é‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        if ($this->detectRapidRequests($user)) {
            $this->temporaryRateLimit($user);
            return true;
        }

        // 4. ç•°å¸¸ãªæ“ä½œãƒ‘ã‚¿ãƒ¼ãƒ³
        if ($this->detectUnusualBehavior($user)) {
            $this->flagForManualReview($user);
        }

        return false;
    }

    /**
     * åœ°ç†çš„ç•°å¸¸æ¤œçŸ¥
     */
    private function detectGeoAnomaly(User $user): bool
    {
        $currentLocation = $this->getIPLocation(request()->ip());
        $lastLocation = $this->getLastLoginLocation($user);

        if (!$lastLocation) {
            return false;
        }

        // å‰å›ãƒ­ã‚°ã‚¤ãƒ³ã‹ã‚‰1æ™‚é–“ä»¥å†…ã«1000kmä»¥ä¸Šç§»å‹•
        $distance = $this->calculateDistance($currentLocation, $lastLocation);
        $timeDiff = now()->diffInHours($user->last_login_at);

        if ($distance > 1000 && $timeDiff < 1) {
            return true;
        }

        return false;
    }
}
```

---

ã“ã‚Œã‚‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…ã«ã‚ˆã‚Šã€ç¾ä»£çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸºæº–ã‚’æº€ãŸã™ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚
