# ä¸æ­£æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ  è©³ç´°è¨­è¨ˆæ›¸

## ğŸ“‹ ç›®æ¬¡
1. [ä¸æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†é¡](#ä¸æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†é¡)
2. [æ¤œçŸ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ](#æ¤œçŸ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ )
3. [æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«](#æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«)
4. [å®Ÿè£…ã‚³ãƒ¼ãƒ‰ä¾‹](#å®Ÿè£…ã‚³ãƒ¼ãƒ‰ä¾‹)
5. [é‹ç”¨ãƒ«ãƒ¼ãƒ«](#é‹ç”¨ãƒ«ãƒ¼ãƒ«)

---

## ğŸ¯ ä¸æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†é¡

### 1. ã‚¯ãƒªãƒƒã‚¯ä¸æ­£

#### 1-1. ã‚¯ãƒªãƒƒã‚¯ã‚¹ãƒ‘ãƒ ï¼ˆClick Spamï¼‰
**ç‰¹å¾´:**
- çŸ­æ™‚é–“ã«åŒä¸€IPã‹ã‚‰å¤§é‡ã‚¯ãƒªãƒƒã‚¯
- ãƒœãƒƒãƒˆã«ã‚ˆã‚‹è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯
- ã‚¯ãƒªãƒƒã‚¯ãƒ•ã‚¡ãƒ¼ãƒ 

**æ¤œçŸ¥æŒ‡æ¨™:**
```
- åŒä¸€IP: 1æ™‚é–“ã«10ã‚¯ãƒªãƒƒã‚¯ä»¥ä¸Š
- åŒä¸€ãƒ‡ãƒã‚¤ã‚¹FP: 1æ™‚é–“ã«15ã‚¯ãƒªãƒƒã‚¯ä»¥ä¸Š
- ã‚¯ãƒªãƒƒã‚¯é–“éš”: å¹³å‡5ç§’ä»¥ä¸‹
- ãƒœãƒƒãƒˆUAç‡: 80%ä»¥ä¸Š
```

#### 1-2. ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆClick Injectionï¼‰
**ç‰¹å¾´:**
- ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç›´å‰ã®ä¸æ­£ã‚¯ãƒªãƒƒã‚¯
- æœ¬æ¥ã®ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¨ªå–ã‚Š

**æ¤œçŸ¥æŒ‡æ¨™:**
```
- ã‚¯ãƒªãƒƒã‚¯â†’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: 5ç§’ä»¥å†…
- ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç›´å‰ã®ç•°å¸¸ã‚¯ãƒªãƒƒã‚¯æ€¥å¢—
```

#### 1-3. Cookieã‚¹ã‚¿ãƒƒãƒ•ã‚£ãƒ³ã‚°ï¼ˆCookie Stuffingï¼‰
**ç‰¹å¾´:**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŸ¥ã‚‰ãªã„ã†ã¡ã«ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆCookieã‚’è¨­å®š
- iframeã‚„è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§å®Ÿæ–½

**æ¤œçŸ¥æŒ‡æ¨™:**
```
- Cookieã‚»ãƒƒãƒˆæ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ»åœ¨æ™‚é–“: 0ç§’
- Refererä¸ä¸€è‡´
- JavaScriptç„¡åŠ¹ç’°å¢ƒã‹ã‚‰ã®Cookie
```

---

### 2. ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸æ­£

#### 2-1. ã‚»ãƒ«ãƒ•ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆ
**ç‰¹å¾´:**
- ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ã‚¿ãƒ¼è‡ªèº«ãŒè³¼å…¥
- åŒä¸€IPã‹ã‚‰ã‚¯ãƒªãƒƒã‚¯â†’è³¼å…¥

**æ¤œçŸ¥æŒ‡æ¨™:**
```
- ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆIDã¨è³¼å…¥è€…æƒ…å ±ã®ä¸€è‡´
- ã‚¯ãƒªãƒƒã‚¯IPã¨è³¼å…¥IPã®å®Œå…¨ä¸€è‡´
- åŒä¸€ãƒ‡ãƒã‚¤ã‚¹ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ
```

#### 2-2. è¿”é‡‘è©æ¬º
**ç‰¹å¾´:**
- ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ‰¿èªå¾Œã«å³è¿”é‡‘
- é«˜é »åº¦ã®è¿”é‡‘ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

**æ¤œçŸ¥æŒ‡æ¨™:**
```
- è¿”é‡‘ç‡: 30%ä»¥ä¸Š
- ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³â†’è¿”é‡‘: 7æ—¥ä»¥å†…
- åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¿”é‡‘å›æ•°: 3å›ä»¥ä¸Š/æœˆ
```

#### 2-3. æ¶ç©ºæ³¨æ–‡
**ç‰¹å¾´:**
- å­˜åœ¨ã—ãªã„æ³¨æ–‡ã®å ±å‘Š
- å½è£…ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿

**æ¤œçŸ¥æŒ‡æ¨™:**
```
- æ³¨æ–‡IDã®é‡è¤‡
- ECå´ã®ãƒ‡ãƒ¼ã‚¿ã¨ä¸ä¸€è‡´
- ç•°å¸¸ãªé«˜é¡æ³¨æ–‡
```

---

## ğŸ” æ¤œçŸ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

### ãƒ¬ãƒ™ãƒ«1: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹æ¤œçŸ¥

```php
class FraudDetectionService
{
    /**
     * ã‚¯ãƒªãƒƒã‚¯ä¸æ­£æ¤œçŸ¥
     */
    public function detectClickFraud($clickData)
    {
        $riskScore = 0;
        $flags = [];

        // 1. IPãƒ¬ãƒ”ãƒ¥ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
        if ($this->isBlacklistedIP($clickData['ip'])) {
            $riskScore += 50;
            $flags[] = 'BLACKLISTED_IP';
        }

        // 2. åŒä¸€IPå¤§é‡ã‚¯ãƒªãƒƒã‚¯æ¤œçŸ¥
        $recentClicks = $this->getRecentClicksByIP(
            $clickData['ip'],
            $clickData['campaign_id'],
            3600 // 1æ™‚é–“
        );

        if ($recentClicks > 10) {
            $riskScore += 30;
            $flags[] = 'EXCESSIVE_CLICKS_SAME_IP';
        }

        // 3. ãƒœãƒƒãƒˆUAæ¤œå‡º
        if ($this->isBotUserAgent($clickData['user_agent'])) {
            $riskScore += 40;
            $flags[] = 'BOT_USER_AGENT';
        }

        // 4. ãƒ‡ãƒã‚¤ã‚¹ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆé‡è¤‡
        $fpClicks = $this->getRecentClicksByFingerprint(
            $clickData['fingerprint'],
            $clickData['campaign_id'],
            3600
        );

        if ($fpClicks > 15) {
            $riskScore += 35;
            $flags[] = 'EXCESSIVE_CLICKS_SAME_DEVICE';
        }

        // 5. Refererãƒã‚§ãƒƒã‚¯
        if (empty($clickData['referer']) ||
            $this->isSuspiciousReferer($clickData['referer'])) {
            $riskScore += 20;
            $flags[] = 'SUSPICIOUS_REFERER';
        }

        // 6. åœ°ç†çš„æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        $ipLocation = $this->getIPLocation($clickData['ip']);
        $targetGeo = $this->getCampaignTargeting($clickData['campaign_id'])['geo'];

        if (!in_array($ipLocation['country'], $targetGeo)) {
            $riskScore += 25;
            $flags[] = 'GEO_MISMATCH';
        }

        // 7. ã‚¯ãƒªãƒƒã‚¯é€Ÿåº¦ãƒã‚§ãƒƒã‚¯ï¼ˆåŒä¸€ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆï¼‰
        $lastClick = $this->getLastClickByAffiliate(
            $clickData['affiliate_id'],
            $clickData['campaign_id']
        );

        if ($lastClick && (time() - $lastClick['timestamp']) < 5) {
            $riskScore += 30;
            $flags[] = 'RAPID_CLICKS';
        }

        return [
            'risk_score' => min($riskScore, 100),
            'flags' => $flags,
            'action' => $this->determineAction($riskScore)
        ];
    }

    /**
     * ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸æ­£æ¤œçŸ¥
     */
    public function detectConversionFraud($conversionData)
    {
        $riskScore = 0;
        $flags = [];

        // 1. ã‚»ãƒ«ãƒ•ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆæ¤œçŸ¥
        $click = $this->getClickByTrackingId($conversionData['tracking_id']);

        if ($this->isSelfAffiliate($click, $conversionData)) {
            $riskScore += 70;
            $flags[] = 'SELF_AFFILIATE';
        }

        // 2. ã‚¯ãƒªãƒƒã‚¯â†’ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ™‚é–“ãƒã‚§ãƒƒã‚¯
        $timeDiff = strtotime($conversionData['converted_at']) -
                    strtotime($click['clicked_at']);

        if ($timeDiff < 10) { // 10ç§’ä»¥å†…
            $riskScore += 50;
            $flags[] = 'INSTANT_CONVERSION';
        }

        if ($timeDiff > 2592000) { // 30æ—¥è¶…é
            $riskScore += 40;
            $flags[] = 'EXPIRED_CONVERSION_WINDOW';
        }

        // 3. ç•°å¸¸é«˜é¡æ³¨æ–‡
        $avgOrderValue = $this->getAverageCampaignOrderValue(
            $conversionData['campaign_id']
        );

        if ($conversionData['order_amount'] > $avgOrderValue * 5) {
            $riskScore += 30;
            $flags[] = 'ABNORMAL_HIGH_ORDER';
        }

        // 4. é¡§å®¢é‡è¤‡ãƒã‚§ãƒƒã‚¯
        $duplicateOrders = $this->getDuplicateCustomerOrders(
            $conversionData['customer_email_hash'],
            $conversionData['affiliate_id'],
            30 // 30æ—¥ä»¥å†…
        );

        if ($duplicateOrders > 3) {
            $riskScore += 40;
            $flags[] = 'DUPLICATE_CUSTOMER';
        }

        // 5. æ³¨æ–‡IDé‡è¤‡
        if ($this->isOrderIdDuplicate($conversionData['order_id'])) {
            $riskScore += 90;
            $flags[] = 'DUPLICATE_ORDER_ID';
        }

        // 6. IPã‚¢ãƒ‰ãƒ¬ã‚¹ä¸€è‡´ç‡ï¼ˆã‚¯ãƒªãƒƒã‚¯ vs ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
        $conversionIP = $this->getConversionIP($conversionData);

        if ($click['ip_address'] !== $conversionIP) {
            $riskScore += 20;
            $flags[] = 'IP_MISMATCH';
        }

        // 7. ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ã‚¿ãƒ¼è¿”é‡‘å±¥æ­´
        $refundRate = $this->getAffiliateRefundRate(
            $conversionData['affiliate_id'],
            90 // éå»90æ—¥
        );

        if ($refundRate > 0.3) { // 30%ä»¥ä¸Š
            $riskScore += 35;
            $flags[] = 'HIGH_REFUND_RATE';
        }

        return [
            'risk_score' => min($riskScore, 100),
            'flags' => $flags,
            'action' => $this->determineAction($riskScore)
        ];
    }

    /**
     * ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ã«åŸºã¥ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ±ºå®š
     */
    private function determineAction($riskScore)
    {
        if ($riskScore >= 80) {
            return 'BLOCK'; // è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯
        } elseif ($riskScore >= 60) {
            return 'MANUAL_REVIEW'; // æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼
        } elseif ($riskScore >= 40) {
            return 'FLAG'; // ãƒ•ãƒ©ã‚°ä»˜ã‘
        } else {
            return 'APPROVE'; // æ‰¿èª
        }
    }

    /**
     * ã‚»ãƒ«ãƒ•ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆåˆ¤å®š
     */
    private function isSelfAffiliate($click, $conversion)
    {
        // 1. IPå®Œå…¨ä¸€è‡´
        if ($click['ip_address'] === $this->getConversionIP($conversion)) {
            return true;
        }

        // 2. ãƒ‡ãƒã‚¤ã‚¹ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆä¸€è‡´
        if ($click['fingerprint'] === $conversion['fingerprint']) {
            return true;
        }

        // 3. ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ã‚¿ãƒ¼æƒ…å ±ã¨è³¼å…¥è€…æƒ…å ±ã®ä¸€è‡´
        $affiliate = $this->getAffiliate($click['affiliate_id']);
        $customerHash = $conversion['customer_email_hash'];

        if (hash('sha256', $affiliate['email']) === $customerHash) {
            return true;
        }

        return false;
    }
}
```

---

### ãƒ¬ãƒ™ãƒ«2: ãƒ™ãƒ­ã‚·ãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ï¼ˆé€Ÿåº¦åˆ¶é™ï¼‰

```php
class VelocityRuleEngine
{
    /**
     * ç•°å¸¸ãªã‚¯ãƒªãƒƒã‚¯é€Ÿåº¦æ¤œçŸ¥
     */
    public function checkClickVelocity($affiliateId, $campaignId)
    {
        $windows = [
            '1min' => 60,
            '5min' => 300,
            '1hour' => 3600,
            '1day' => 86400
        ];

        $thresholds = [
            '1min' => 5,
            '5min' => 20,
            '1hour' => 100,
            '1day' => 500
        ];

        foreach ($windows as $name => $seconds) {
            $count = $this->getClickCount($affiliateId, $campaignId, $seconds);

            if ($count > $thresholds[$name]) {
                return [
                    'exceeded' => true,
                    'window' => $name,
                    'count' => $count,
                    'threshold' => $thresholds[$name],
                    'action' => 'RATE_LIMIT'
                ];
            }
        }

        return ['exceeded' => false];
    }

    /**
     * ç•°å¸¸ãªã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³é€Ÿåº¦æ¤œçŸ¥
     */
    public function checkConversionVelocity($affiliateId)
    {
        // é€šå¸¸ã¨ã¯ç•°ãªã‚‹æ€¥æ¿€ãªã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¢—åŠ ã‚’æ¤œçŸ¥
        $currentRate = $this->getConversionRate($affiliateId, 3600); // 1æ™‚é–“
        $historicalRate = $this->getHistoricalConversionRate($affiliateId, 30); // 30æ—¥å¹³å‡

        if ($currentRate > $historicalRate * 10) {
            return [
                'anomaly' => true,
                'current_rate' => $currentRate,
                'historical_rate' => $historicalRate,
                'multiplier' => $currentRate / $historicalRate
            ];
        }

        return ['anomaly' => false];
    }
}
```

---

### ãƒ¬ãƒ™ãƒ«3: ã‚°ãƒ©ãƒ•åˆ†æï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸æ­£æ¤œçŸ¥ï¼‰

```php
class FraudNetworkDetector
{
    /**
     * ä¸æ­£ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¤œçŸ¥
     * è¤‡æ•°ã®ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ãŒå”åŠ›ã—ã¦ä¸æ­£ã‚’è¡Œã†ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œçŸ¥
     */
    public function detectFraudNetwork()
    {
        // 1. ç–‘ã‚ã—ã„ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç‰¹å®š
        $suspiciousGroups = $this->findSuspiciousGroups();

        foreach ($suspiciousGroups as $group) {
            // 2. ã‚°ãƒ©ãƒ•æ§‹é€ ã‚’æ§‹ç¯‰
            $graph = $this->buildNetworkGraph($group['affiliates']);

            // 3. å…±é€šãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ
            $commonPatterns = [
                'shared_ips' => $this->findSharedIPs($graph),
                'shared_devices' => $this->findSharedDevices($graph),
                'coordinated_timing' => $this->detectCoordinatedActivity($graph),
                'circular_referrals' => $this->detectCircularReferrals($graph)
            ];

            // 4. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢è¨ˆç®—
            $networkRiskScore = $this->calculateNetworkRisk($commonPatterns);

            if ($networkRiskScore > 70) {
                $this->flagFraudNetwork($group['affiliates'], $commonPatterns);
            }
        }
    }

    /**
     * ç–‘ã‚ã—ã„ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ç‰¹å®š
     */
    private function findSuspiciousGroups()
    {
        // åŒä¸€IPã‹ã‚‰è¤‡æ•°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²
        $ipGroups = DB::table('users')
            ->select('last_login_ip', DB::raw('COUNT(*) as count'))
            ->where('user_type', 'affiliate')
            ->groupBy('last_login_ip')
            ->having('count', '>=', 3)
            ->get();

        // çŸ­æœŸé–“ã§ã®å¤§é‡ç´¹ä»‹
        $referralGroups = DB::table('users')
            ->select('referrer_id', DB::raw('COUNT(*) as count'))
            ->where('created_at', '>=', now()->subDays(7))
            ->groupBy('referrer_id')
            ->having('count', '>=', 10)
            ->get();

        return array_merge($ipGroups, $referralGroups);
    }

    /**
     * å¾ªç’°ç´¹ä»‹æ¤œçŸ¥ï¼ˆAâ†’Bâ†’Câ†’Aï¼‰
     */
    private function detectCircularReferrals($graph)
    {
        $visited = [];
        $cycles = [];

        foreach ($graph as $node => $edges) {
            $path = [$node];
            $current = $node;

            while (isset($graph[$current]['referrer'])) {
                $referrer = $graph[$current]['referrer'];

                if (in_array($referrer, $path)) {
                    // å¾ªç’°ç™ºè¦‹
                    $cycles[] = array_merge(
                        array_slice($path, array_search($referrer, $path)),
                        [$referrer]
                    );
                    break;
                }

                $path[] = $referrer;
                $current = $referrer;
            }
        }

        return $cycles;
    }
}
```

---

## ğŸ¤– æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«

### ãƒ¢ãƒ‡ãƒ«1: ãƒ©ãƒ³ãƒ€ãƒ ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆï¼ˆã‚¯ãƒªãƒƒã‚¯ä¸æ­£åˆ†é¡ï¼‰

```python
import pandas as pd
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import classification_report

class ClickFraudMLModel:
    def __init__(self):
        self.model = RandomForestClassifier(
            n_estimators=100,
            max_depth=10,
            random_state=42
        )

    def prepare_features(self, click_data):
        """ç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°"""
        features = pd.DataFrame({
            # æ™‚é–“ç‰¹å¾´
            'hour_of_day': click_data['clicked_at'].dt.hour,
            'day_of_week': click_data['clicked_at'].dt.dayofweek,

            # ã‚¯ãƒªãƒƒã‚¯é–“éš”
            'time_since_last_click': click_data.groupby('affiliate_id')['clicked_at'].diff().dt.total_seconds(),

            # IPãƒ™ãƒ¼ã‚¹ç‰¹å¾´
            'ip_click_count_1h': self.get_ip_click_count(click_data, window='1H'),
            'ip_click_count_24h': self.get_ip_click_count(click_data, window='24H'),

            # ãƒ‡ãƒã‚¤ã‚¹ç‰¹å¾´
            'device_type_encoded': pd.get_dummies(click_data['device_type']),
            'is_mobile': (click_data['device_type'] == 'mobile').astype(int),

            # ãƒ–ãƒ©ã‚¦ã‚¶ç‰¹å¾´
            'browser_version': click_data['browser'].str.extract(r'(\d+)')[0].astype(float),
            'is_bot_ua': click_data['user_agent'].str.contains('bot|crawler|spider', case=False).astype(int),

            # åœ°ç†çš„ç‰¹å¾´
            'country_risk_score': click_data['country_code'].map(self.country_risk_scores),
            'geo_velocity': self.calculate_geo_velocity(click_data),

            # ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ç‰¹å¾´
            'affiliate_age_days': (pd.Timestamp.now() - click_data['affiliate_created_at']).dt.days,
            'affiliate_click_count_total': click_data.groupby('affiliate_id').cumcount(),
            'affiliate_fraud_history': click_data['affiliate_id'].map(self.fraud_history),

            # ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç‰¹å¾´
            'campaign_avg_cvr': click_data['campaign_id'].map(self.campaign_cvr),
            'commission_value': click_data['commission_value'],

            # Refererç‰¹å¾´
            'has_referer': (~click_data['referer'].isna()).astype(int),
            'referer_domain': click_data['referer'].str.extract(r'https?://([^/]+)')[0],

            # ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆç‰¹å¾´
            'fp_click_count_1h': self.get_fp_click_count(click_data, window='1H'),
        })

        return features

    def train(self, X_train, y_train):
        """ãƒ¢ãƒ‡ãƒ«è¨“ç·´"""
        self.model.fit(X_train, y_train)

        # ç‰¹å¾´é‡é‡è¦åº¦
        feature_importance = pd.DataFrame({
            'feature': X_train.columns,
            'importance': self.model.feature_importances_
        }).sort_values('importance', ascending=False)

        print("Top 10 Important Features:")
        print(feature_importance.head(10))

        return self.model

    def predict_fraud_probability(self, click_data):
        """ä¸æ­£ç¢ºç‡äºˆæ¸¬"""
        features = self.prepare_features(click_data)
        probabilities = self.model.predict_proba(features)[:, 1]  # ä¸æ­£ã‚¯ãƒ©ã‚¹ã®ç¢ºç‡

        return pd.DataFrame({
            'click_id': click_data['id'],
            'fraud_probability': probabilities,
            'fraud_score': (probabilities * 100).astype(int),
            'predicted_label': (probabilities > 0.5).astype(int)
        })
```

---

### ãƒ¢ãƒ‡ãƒ«2: Isolation Forestï¼ˆç•°å¸¸æ¤œçŸ¥ï¼‰

```python
from sklearn.ensemble import IsolationForest

class AnomalyDetector:
    def __init__(self):
        self.model = IsolationForest(
            contamination=0.1,  # 10%ãŒç•°å¸¸ã¨ä»®å®š
            random_state=42
        )

    def detect_anomalies(self, conversion_data):
        """ç•°å¸¸ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¤œçŸ¥"""
        features = pd.DataFrame({
            'order_amount': conversion_data['order_amount'],
            'commission_amount': conversion_data['commission_amount'],
            'time_to_conversion': conversion_data['time_to_conversion_seconds'],
            'customer_lifetime_orders': conversion_data['customer_order_count'],
            'affiliate_cvr': conversion_data['affiliate_conversion_rate'],
            'device_switches': conversion_data['device_change_count']
        })

        # æ¨™æº–åŒ–
        from sklearn.preprocessing import StandardScaler
        scaler = StandardScaler()
        features_scaled = scaler.fit_transform(features)

        # ç•°å¸¸ã‚¹ã‚³ã‚¢è¨ˆç®—
        anomaly_scores = self.model.fit_predict(features_scaled)
        anomaly_probs = self.model.score_samples(features_scaled)

        return pd.DataFrame({
            'conversion_id': conversion_data['id'],
            'is_anomaly': (anomaly_scores == -1).astype(int),
            'anomaly_score': anomaly_probs,
            'anomaly_rank': pd.Series(anomaly_probs).rank(ascending=True)
        })
```

---

### ãƒ¢ãƒ‡ãƒ«3: LSTMï¼ˆæ™‚ç³»åˆ—ç•°å¸¸æ¤œçŸ¥ï¼‰

```python
import tensorflow as tf
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense, Dropout

class TimeSeriesAnomalyDetector:
    def __init__(self, sequence_length=24):
        self.sequence_length = sequence_length
        self.model = self.build_model()

    def build_model(self):
        """LSTM ã‚ªãƒ¼ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼æ§‹ç¯‰"""
        model = Sequential([
            LSTM(64, activation='relu', input_shape=(self.sequence_length, 1), return_sequences=True),
            Dropout(0.2),
            LSTM(32, activation='relu', return_sequences=False),
            Dropout(0.2),
            Dense(32, activation='relu'),
            Dense(64, activation='relu'),
            Dense(self.sequence_length)
        ])

        model.compile(optimizer='adam', loss='mse')
        return model

    def detect_traffic_anomaly(self, hourly_click_data):
        """æ™‚ç³»åˆ—ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ç•°å¸¸æ¤œçŸ¥"""
        # éå»24æ™‚é–“ã®ã‚¯ãƒªãƒƒã‚¯æ•°ã‚’ä½¿ç”¨
        sequences = self.create_sequences(hourly_click_data, self.sequence_length)

        # æ­£å¸¸ãƒ‡ãƒ¼ã‚¿ã§è¨“ç·´
        normal_data = sequences[sequences['is_fraud'] == 0]
        self.model.fit(
            normal_data['sequence'],
            normal_data['sequence'],
            epochs=50,
            batch_size=32,
            validation_split=0.2,
            verbose=0
        )

        # å†æ§‹æˆã‚¨ãƒ©ãƒ¼ã§ç•°å¸¸æ¤œçŸ¥
        reconstructions = self.model.predict(sequences['sequence'])
        reconstruction_errors = np.mean(np.abs(sequences['sequence'] - reconstructions), axis=1)

        # é–¾å€¤è¨­å®šï¼ˆæ­£å¸¸ãƒ‡ãƒ¼ã‚¿ã®99ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«ï¼‰
        threshold = np.percentile(reconstruction_errors, 99)

        return pd.DataFrame({
            'timestamp': sequences['timestamp'],
            'reconstruction_error': reconstruction_errors,
            'is_anomaly': (reconstruction_errors > threshold).astype(int),
            'anomaly_severity': (reconstruction_errors / threshold * 100).clip(0, 100)
        })
```

---

## ğŸ›¡ å®Ÿè£…ã‚³ãƒ¼ãƒ‰ä¾‹

### ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¸æ­£æ¤œçŸ¥ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```php
// app/Services/FraudDetection/FraudDetectionPipeline.php

class FraudDetectionPipeline
{
    private $detectors = [];

    public function __construct()
    {
        // æ¤œçŸ¥å™¨ã‚’å„ªå…ˆåº¦é †ã«ç™»éŒ²
        $this->registerDetector(new BlacklistDetector(), 1);
        $this->registerDetector(new RuleBasedDetector(), 2);
        $this->registerDetector(new VelocityDetector(), 3);
        $this->registerDetector(new MLDetector(), 4);
        $this->registerDetector(new NetworkDetector(), 5);
    }

    /**
     * ã‚¯ãƒªãƒƒã‚¯æ¤œè¨¼ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
     */
    public function validateClick($clickData)
    {
        $results = [];
        $totalRiskScore = 0;

        foreach ($this->detectors as $detector) {
            $result = $detector->analyze($clickData);

            $results[$detector->getName()] = $result;
            $totalRiskScore += $result['risk_score'] * $detector->getWeight();

            // å³åº§ã«ãƒ–ãƒ­ãƒƒã‚¯ã™ã¹ããƒ¬ãƒ™ãƒ«ã®ä¸æ­£æ¤œçŸ¥
            if ($result['action'] === 'BLOCK') {
                $this->logFraudDetection($clickData, $results, 'BLOCKED');
                throw new FraudDetectedException('ã‚¯ãƒªãƒƒã‚¯ãŒä¸æ­£ã¨åˆ¤å®šã•ã‚Œã¾ã—ãŸ');
            }
        }

        // ç·åˆåˆ¤å®š
        $finalAction = $this->determineFinalAction($totalRiskScore);

        // ãƒ­ã‚°è¨˜éŒ²
        $this->saveFraudLog([
            'entity_type' => 'click',
            'entity_id' => $clickData['id'],
            'risk_score' => $totalRiskScore,
            'detection_results' => $results,
            'action' => $finalAction
        ]);

        return [
            'allowed' => $finalAction !== 'BLOCK',
            'risk_score' => $totalRiskScore,
            'action' => $finalAction,
            'flags' => $this->aggregateFlags($results)
        ];
    }

    /**
     * éåŒæœŸã§ã®è©³ç´°åˆ†æ
     */
    public function queueDetailedAnalysis($clickData)
    {
        // æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚„é‡ã„å‡¦ç†ã¯éåŒæœŸå®Ÿè¡Œ
        dispatch(new AnalyzeClickFraudJob($clickData));
    }
}
```

---

### ãƒ‡ãƒã‚¤ã‚¹ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆç”Ÿæˆ

```javascript
// resources/js/fraud-detection/fingerprint.js

class DeviceFingerprint {
    async generate() {
        const components = {
            // ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±
            userAgent: navigator.userAgent,
            language: navigator.language,
            platform: navigator.platform,
            hardwareConcurrency: navigator.hardwareConcurrency,
            deviceMemory: navigator.deviceMemory,

            // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æƒ…å ±
            screenResolution: `${screen.width}x${screen.height}`,
            colorDepth: screen.colorDepth,
            pixelRatio: window.devicePixelRatio,

            // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            timezoneOffset: new Date().getTimezoneOffset(),

            // Canvas ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ
            canvas: await this.getCanvasFingerprint(),

            // WebGL ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ
            webgl: await this.getWebGLFingerprint(),

            // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ
            audio: await this.getAudioFingerprint(),

            // ãƒ•ã‚©ãƒ³ãƒˆæ¤œå‡º
            fonts: await this.detectFonts(),

            // ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
            plugins: this.getPlugins(),

            // ã‚¿ãƒƒãƒã‚µãƒãƒ¼ãƒˆ
            touchSupport: 'ontouchstart' in window,

            // ãƒãƒƒãƒ†ãƒªãƒ¼æƒ…å ±ï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
            battery: await this.getBatteryInfo()
        };

        // SHA-256 ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆ
        const fingerprint = await this.hash(JSON.stringify(components));

        return {
            fingerprint: fingerprint,
            components: components
        };
    }

    async getCanvasFingerprint() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.textBaseline = 'alphabetic';
        ctx.fillStyle = '#f60';
        ctx.fillRect(125, 1, 62, 20);
        ctx.fillStyle = '#069';
        ctx.fillText('FingerprintJS', 2, 15);
        ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
        ctx.fillText('FingerprintJS', 4, 17);

        return canvas.toDataURL();
    }

    async hash(text) {
        const encoder = new TextEncoder();
        const data = encoder.encode(text);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
}

// ä½¿ç”¨ä¾‹
const fp = new DeviceFingerprint();
const result = await fp.generate();
console.log('Fingerprint:', result.fingerprint);
```

---

## ğŸ“Š é‹ç”¨ãƒ«ãƒ¼ãƒ«

### è‡ªå‹•å¯¾å¿œãƒ•ãƒ­ãƒ¼

```
ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ 0-39ç‚¹
â””â†’ è‡ªå‹•æ‰¿èª
   â”œâ†’ é€šå¸¸å‡¦ç†
   â””â†’ ãƒ­ã‚°è¨˜éŒ²ã®ã¿

ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ 40-59ç‚¹
â””â†’ ãƒ•ãƒ©ã‚°ä»˜ã‘
   â”œâ†’ æ‰¿èªï¼ˆæ¡ä»¶ä»˜ãï¼‰
   â”œâ†’ ç›£è¦–ãƒªã‚¹ãƒˆè¿½åŠ 
   â””â†’ é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡

ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ 60-79ç‚¹
â””â†’ æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…é ˆ
   â”œâ†’ ä¿ç•™çŠ¶æ…‹
   â”œâ†’ ç®¡ç†è€…é€šçŸ¥
   â””â†’ 24æ™‚é–“ä»¥å†…ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼

ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ 80-100ç‚¹
â””â†’ è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯
   â”œâ†’ å³åº§ã«æ‹’å¦
   â”œâ†’ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸€æ™‚åœæ­¢
   â””â†’ ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
```

### æ®µéšçš„åˆ¶è£æªç½®

```php
class FraudPenaltySystem
{
    public function applyPenalty($affiliateId, $fraudSeverity)
    {
        $history = $this->getFraudHistory($affiliateId);

        switch ($fraudSeverity) {
            case 'LOW':
                if ($history['low_count'] >= 3) {
                    $this->issueWarning($affiliateId);
                }
                break;

            case 'MEDIUM':
                if ($history['medium_count'] >= 2) {
                    $this->suspendAccount($affiliateId, days: 7);
                } else {
                    $this->reduceCommission($affiliateId, percentage: 50);
                }
                break;

            case 'HIGH':
                $this->permanentBan($affiliateId);
                $this->blacklistRelatedAccounts($affiliateId);
                break;
        }
    }
}
```

---

ã“ã®ä¸æ­£æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šã€ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆä¸æ­£ã‚’å¤šå±¤çš„ã«é˜²å¾¡ã§ãã¾ã™ã€‚
