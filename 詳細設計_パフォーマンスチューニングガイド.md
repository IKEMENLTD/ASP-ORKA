# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰

## ğŸ“‹ ç›®æ¬¡
1. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™)
2. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–)
3. [ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥](#ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥)
4. [éåŒæœŸå‡¦ç†](#éåŒæœŸå‡¦ç†)
5. [ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æœ€é©åŒ–](#ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æœ€é©åŒ–)
6. [è² è·ãƒ†ã‚¹ãƒˆ](#è² è·ãƒ†ã‚¹ãƒˆ)

---

## ğŸ¯ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ç›®æ¨™

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | P50 | P95 | P99 | æœ€å¤§ |
|---------------|-----|-----|-----|------|
| GET /campaigns | 50ms | 150ms | 300ms | 1s |
| POST /tracking/click | 30ms | 100ms | 200ms | 500ms |
| POST /tracking/conversion | 80ms | 200ms | 400ms | 1s |
| GET /dashboard | 200ms | 500ms | 1s | 2s |
| GET /reports/* | 500ms | 2s | 5s | 10s |

### ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆç›®æ¨™

```
åŒæ™‚æ¥ç¶šæ•°: 10,000+
ç§’é–“ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: 1,000+ RPS
æ—¥æ¬¡ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯: 1å„„PV
æœˆé–“ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1,000ä¸‡ä»¶
```

---

## ğŸ—„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–

### 1. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–

```sql
-- âŒ æ‚ªã„ä¾‹: ãƒ•ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ£ãƒ³
SELECT * FROM clicks
WHERE campaign_id = 1001
  AND clicked_at >= '2024-01-01'
ORDER BY clicked_at DESC
LIMIT 100;

-- EXPLAINçµæœ
-- type: ALL (ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³)
-- rows: 10,000,000
-- Extra: Using where; Using filesort

-- âœ… è‰¯ã„ä¾‹: è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨
CREATE INDEX idx_clicks_campaign_date ON clicks (
    campaign_id,
    clicked_at DESC
);

-- EXPLAINçµæœ
-- type: range
-- rows: 1,234
-- Extra: Using index condition
```

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³

```sql
-- ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£é †
CREATE INDEX idx_conversions_optimal ON conversions (
    status,           -- é«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ï¼ˆ4ç¨®é¡ï¼‰
    affiliate_id,     -- ä¸­ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ï¼ˆæ•°ä¸‡ï¼‰
    converted_at      -- é«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰
);

-- ãƒ‘ã‚¿ãƒ¼ãƒ³2: ã‚«ãƒãƒªãƒ³ã‚°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_conversion_summary ON conversions (
    affiliate_id,
    status,
    converted_at
) INCLUDE (
    commission_amount,
    order_amount
);

-- ãƒ‘ã‚¿ãƒ¼ãƒ³3: éƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆPostgreSQLï¼‰
CREATE INDEX idx_active_campaigns ON campaigns (id)
WHERE status = 'active';

-- ãƒ‘ã‚¿ãƒ¼ãƒ³4: é–¢æ•°ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_email_lower ON users (LOWER(email));
```

---

### 2. ã‚¯ã‚¨ãƒªæœ€é©åŒ–

#### N+1å•é¡Œã®è§£æ¶ˆ

```php
// âŒ æ‚ªã„ä¾‹: N+1ã‚¯ã‚¨ãƒªï¼ˆ101å›ã®ã‚¯ã‚¨ãƒªï¼‰
$conversions = Conversion::limit(100)->get();

foreach ($conversions as $conversion) {
    echo $conversion->campaign->name;  // å„è¡Œã§1ã‚¯ã‚¨ãƒª
}

// âœ… è‰¯ã„ä¾‹: Eager Loadingï¼ˆ2å›ã®ã‚¯ã‚¨ãƒªï¼‰
$conversions = Conversion::with('campaign')->limit(100)->get();

foreach ($conversions as $conversion) {
    echo $conversion->campaign->name;
}

// âœ… ã•ã‚‰ã«è‰¯ã„ä¾‹: é¸æŠçš„ Eager Loading
$conversions = Conversion::with('campaign:id,name')
    ->select('id', 'campaign_id', 'commission_amount')
    ->limit(100)
    ->get();
```

#### ã‚µãƒ–ã‚¯ã‚¨ãƒªæœ€é©åŒ–

```sql
-- âŒ é…ã„: ç›¸é–¢ã‚µãƒ–ã‚¯ã‚¨ãƒª
SELECT a.id, a.name,
    (SELECT COUNT(*) FROM conversions WHERE affiliate_id = a.id) as conversion_count
FROM affiliates a;

-- âœ… é€Ÿã„: JOIN
SELECT a.id, a.name, COUNT(c.id) as conversion_count
FROM affiliates a
LEFT JOIN conversions c ON c.affiliate_id = a.id
GROUP BY a.id, a.name;

-- âœ… ã•ã‚‰ã«é€Ÿã„: é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ä½¿ç”¨
SELECT a.id, a.name, s.conversion_count
FROM affiliates a
LEFT JOIN affiliate_statistics s ON s.affiliate_id = a.id;
```

---

### 3. ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°

```sql
-- æœˆæ¬¡ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ï¼ˆclicks ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
CREATE TABLE clicks (
    id BIGINT AUTO_INCREMENT,
    campaign_id BIGINT NOT NULL,
    clicked_at TIMESTAMP NOT NULL,
    ...
    PRIMARY KEY (id, clicked_at)
) PARTITION BY RANGE (UNIX_TIMESTAMP(clicked_at)) (
    PARTITION p202401 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-01')),
    PARTITION p202402 VALUES LESS THAN (UNIX_TIMESTAMP('2024-03-01')),
    ...
);

-- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ãƒ—ãƒ«ãƒ¼ãƒ‹ãƒ³ã‚°åŠ¹æœ
-- âœ… 1ãƒ¶æœˆåˆ†ã®ã¿ã‚¹ã‚­ãƒ£ãƒ³
SELECT * FROM clicks
WHERE clicked_at >= '2024-01-01' AND clicked_at < '2024-02-01';

-- å¤ã„ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆé«˜é€Ÿï¼‰
ALTER TABLE clicks DROP PARTITION p202301;
```

---

### 4. é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼ï¼‰

```sql
-- æ—¥æ¬¡é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE daily_campaign_stats (
    date DATE NOT NULL,
    campaign_id BIGINT NOT NULL,
    clicks INT DEFAULT 0,
    conversions INT DEFAULT 0,
    revenue DECIMAL(15,2) DEFAULT 0,
    commission DECIMAL(15,2) DEFAULT 0,
    cvr DECIMAL(5,2) DEFAULT 0,
    PRIMARY KEY (date, campaign_id),
    INDEX idx_campaign (campaign_id, date),
    INDEX idx_date (date)
) ENGINE=InnoDB;

-- æ—¥æ¬¡ãƒãƒƒãƒã§æ›´æ–°
INSERT INTO daily_campaign_stats
SELECT
    DATE(clicked_at) as date,
    campaign_id,
    COUNT(*) as clicks,
    SUM(CASE WHEN conversion_id IS NOT NULL THEN 1 ELSE 0 END) as conversions,
    SUM(COALESCE(order_amount, 0)) as revenue,
    SUM(COALESCE(commission_amount, 0)) as commission,
    ROUND(SUM(CASE WHEN conversion_id IS NOT NULL THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as cvr
FROM clicks c
LEFT JOIN conversions conv ON conv.click_id = c.id
WHERE DATE(clicked_at) = CURDATE() - INTERVAL 1 DAY
GROUP BY DATE(clicked_at), campaign_id
ON DUPLICATE KEY UPDATE
    clicks = VALUES(clicks),
    conversions = VALUES(conversions),
    revenue = VALUES(revenue),
    commission = VALUES(commission),
    cvr = VALUES(cvr);
```

---

## ğŸš€ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

### 1. Redis ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£…

```php
<?php
// app/Services/Cache/CampaignCache.php

class CampaignCache
{
    private $redis;
    private $ttl = 3600; // 1æ™‚é–“

    /**
     * ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä¸€è¦§ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
     */
    public function getActiveCampaigns(): array
    {
        $cacheKey = 'campaigns:active';

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—
        $cached = $this->redis->get($cacheKey);

        if ($cached !== false) {
            return json_decode($cached, true);
        }

        // DB ã‹ã‚‰å–å¾—
        $campaigns = Campaign::where('status', 'active')
            ->where('starts_at', '<=', now())
            ->where(function($q) {
                $q->whereNull('ends_at')
                  ->orWhere('ends_at', '>=', now());
            })
            ->select('id', 'name', 'commission_type', 'commission_value')
            ->get()
            ->toArray();

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        $this->redis->setex($cacheKey, $this->ttl, json_encode($campaigns));

        return $campaigns;
    }

    /**
     * ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³è©³ç´°ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
     */
    public function getCampaign(int $id): ?array
    {
        $cacheKey = "campaign:{$id}";

        return Cache::remember($cacheKey, $this->ttl, function() use ($id) {
            return Campaign::with(['category', 'creatives'])
                ->find($id)
                ?->toArray();
        });
    }

    /**
     * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
     */
    public function invalidate(int $campaignId): void
    {
        Cache::forget("campaign:{$campaignId}");
        Cache::forget('campaigns:active');
        Cache::tags(['campaigns'])->flush();
    }
}
```

---

### 2. ã‚¯ã‚¨ãƒªçµæœã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå¤šå±¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰

```php
<?php
// å¤šå±¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

class MultiLayerCache
{
    /**
     * L1: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆAPCuï¼‰
     * L2: Redisï¼ˆåˆ†æ•£ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
     * L3: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
     */
    public function get(string $key, Closure $callback, int $ttl = 3600)
    {
        // L1: APCu ãƒã‚§ãƒƒã‚¯
        if (extension_loaded('apcu')) {
            $l1Value = apcu_fetch($key, $success);
            if ($success) {
                return $l1Value;
            }
        }

        // L2: Redis ãƒã‚§ãƒƒã‚¯
        $l2Value = Redis::get($key);
        if ($l2Value !== null) {
            // L1ã«æ›¸ãæˆ»ã—
            if (extension_loaded('apcu')) {
                apcu_store($key, $l2Value, min($ttl, 300)); // æœ€å¤§5åˆ†
            }
            return $l2Value;
        }

        // L3: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
        $value = $callback();

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        Redis::setex($key, $ttl, $value);

        if (extension_loaded('apcu')) {
            apcu_store($key, $value, min($ttl, 300));
        }

        return $value;
    }
}
```

---

### 3. CDN / é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚­ãƒ£ãƒƒã‚·ãƒ¥

```nginx
# nginx.conf

# é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff2)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header X-Content-Type-Options "nosniff";
}

# API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆnginx proxy cacheï¼‰
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=1g inactive=60m;

location /api/v1/campaigns {
    proxy_cache api_cache;
    proxy_cache_valid 200 5m;
    proxy_cache_key "$scheme$request_method$host$request_uri";
    proxy_cache_bypass $http_cache_control;
    add_header X-Cache-Status $upstream_cache_status;

    proxy_pass http://backend;
}
```

---

## âš¡ éåŒæœŸå‡¦ç†

### 1. ã‚­ãƒ¥ãƒ¼å®Ÿè£…ï¼ˆLaravel Queueï¼‰

```php
<?php
// app/Jobs/ProcessConversionJob.php

class ProcessConversionJob implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    public $tries = 3;
    public $timeout = 120;
    public $backoff = [10, 30, 60]; // ãƒªãƒˆãƒ©ã‚¤é–“éš”ï¼ˆç§’ï¼‰

    private $conversionData;

    public function __construct(array $conversionData)
    {
        $this->conversionData = $conversionData;
    }

    public function handle()
    {
        DB::transaction(function() {
            // 1. ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç™»éŒ²
            $conversion = Conversion::create($this->conversionData);

            // 2. ä¸æ­£æ¤œçŸ¥
            $fraudCheck = app(FraudDetectionService::class)
                ->detectConversionFraud($conversion);

            $conversion->update([
                'fraud_score' => $fraudCheck['risk_score'],
                'is_suspicious' => $fraudCheck['action'] !== 'APPROVE'
            ]);

            // 3. å ±é…¬è¨ˆç®—
            if ($fraudCheck['action'] === 'APPROVE') {
                app(CommissionService::class)->calculateCommission($conversion);
            }

            // 4. çµ±è¨ˆæ›´æ–°
            app(StatisticsService::class)->updateCampaignStats($conversion);

            // 5. Webhook é€šçŸ¥ï¼ˆéåŒæœŸï¼‰
            dispatch(new SendWebhookJob('conversion.created', $conversion));

            // 6. ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ï¼ˆéåŒæœŸï¼‰
            if ($conversion->status === 'approved') {
                dispatch(new SendConversionNotificationJob($conversion));
            }
        });
    }

    public function failed(Throwable $exception)
    {
        Log::error('Conversion processing failed', [
            'conversion_data' => $this->conversionData,
            'error' => $exception->getMessage()
        ]);

        // å¤±æ•—é€šçŸ¥
        Notification::route('slack', config('slack.webhook_url'))
            ->notify(new JobFailedNotification($exception));
    }
}

// ã‚¸ãƒ§ãƒ–ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒ
dispatch(new ProcessConversionJob($conversionData))
    ->onQueue('conversions')  // å°‚ç”¨ã‚­ãƒ¥ãƒ¼
    ->delay(now()->addSeconds(5));  // 5ç§’é…å»¶
```

---

### 2. ãƒãƒƒãƒå‡¦ç†æœ€é©åŒ–

```php
<?php
// app/Console/Commands/ProcessDailyStatistics.php

class ProcessDailyStatistics extends Command
{
    protected $signature = 'stats:daily {date?}';

    public function handle()
    {
        $date = $this->argument('date') ?: Carbon::yesterday()->toDateString();

        // ãƒãƒ£ãƒ³ã‚¯å‡¦ç†ï¼ˆãƒ¡ãƒ¢ãƒªåŠ¹ç‡åŒ–ï¼‰
        DB::table('clicks')
            ->whereDate('clicked_at', $date)
            ->orderBy('id')
            ->chunk(1000, function($clicks) use ($date) {
                $this->processChunk($clicks, $date);
            });

        $this->info('Daily statistics processed successfully');
    }

    private function processChunk($clicks, $date)
    {
        $stats = [];

        foreach ($clicks as $click) {
            $key = $click->campaign_id;

            if (!isset($stats[$key])) {
                $stats[$key] = [
                    'date' => $date,
                    'campaign_id' => $click->campaign_id,
                    'clicks' => 0,
                    'unique_clicks' => [],
                ];
            }

            $stats[$key]['clicks']++;
            $stats[$key]['unique_clicks'][$click->ip_address] = true;
        }

        // ãƒãƒ«ã‚¯ã‚¤ãƒ³ã‚µãƒ¼ãƒˆ
        foreach ($stats as $stat) {
            DailyCampaignStat::updateOrCreate(
                [
                    'date' => $stat['date'],
                    'campaign_id' => $stat['campaign_id']
                ],
                [
                    'clicks' => DB::raw('clicks + ' . $stat['clicks']),
                    'unique_clicks' => count($stat['unique_clicks'])
                ]
            );
        }
    }
}
```

---

## ğŸŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æœ€é©åŒ–

### 1. é…å»¶èª­ã¿è¾¼ã¿ï¼ˆLazy Loadingï¼‰

```javascript
// Vue.js ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé…å»¶èª­ã¿è¾¼ã¿
const routes = [
    {
        path: '/dashboard',
        component: () => import(/* webpackChunkName: "dashboard" */ './views/Dashboard.vue')
    },
    {
        path: '/campaigns',
        component: () => import(/* webpackChunkName: "campaigns" */ './views/Campaigns.vue')
    }
];

// ç”»åƒé…å»¶èª­ã¿è¾¼ã¿
<img
    data-src="/images/banner.jpg"
    class="lazy"
    loading="lazy"
    alt="Banner"
/>

// Intersection Observer API
const lazyImages = document.querySelectorAll('img.lazy');

const imageObserver = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const img = entry.target;
            img.src = img.dataset.src;
            img.classList.remove('lazy');
            observer.unobserve(img);
        }
    });
});

lazyImages.forEach(img => imageObserver.observe(img));
```

---

### 2. ãƒãƒ³ãƒ‰ãƒ«æœ€é©åŒ–

```javascript
// vite.config.js
import { defineConfig } from 'vite';
import vue from '@vitejs/plugin-vue';

export default defineConfig({
    plugins: [vue()],
    build: {
        rollupOptions: {
            output: {
                manualChunks: {
                    // ãƒ™ãƒ³ãƒ€ãƒ¼ã‚³ãƒ¼ãƒ‰åˆ†å‰²
                    'vendor': ['vue', 'vue-router', 'axios'],
                    'charts': ['chart.js'],
                    'ui': ['element-plus']
                }
            }
        },
        // åœ§ç¸®
        minify: 'terser',
        terserOptions: {
            compress: {
                drop_console: true,  // console.logå‰Šé™¤
                drop_debugger: true
            }
        }
    }
});
```

---

### 3. Service Workerï¼ˆPWAï¼‰

```javascript
// service-worker.js

const CACHE_NAME = 'affiliate-system-v1';
const urlsToCache = [
    '/',
    '/css/app.css',
    '/js/app.js',
    '/images/logo.png'
];

// ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
self.addEventListener('install', event => {
    event.waitUntil(
        caches.open(CACHE_NAME)
            .then(cache => cache.addAll(urlsToCache))
    );
});

// ãƒ•ã‚§ãƒƒãƒï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆï¼‰
self.addEventListener('fetch', event => {
    event.respondWith(
        caches.match(event.request)
            .then(response => {
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ
                if (response) {
                    return response;
                }

                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰å–å¾—
                return fetch(event.request).then(response => {
                    // 200ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
                    if (!response || response.status !== 200) {
                        return response;
                    }

                    const responseToCache = response.clone();

                    caches.open(CACHE_NAME).then(cache => {
                        cache.put(event.request, responseToCache);
                    });

                    return response;
                });
            })
    );
});
```

---

## ğŸ§ª è² è·ãƒ†ã‚¹ãƒˆ

### 1. Apache JMeter ã‚·ãƒŠãƒªã‚ª

```xml
<!-- jmeter-test-plan.jmx -->
<?xml version="1.0" encoding="UTF-8"?>
<jmeterTestPlan version="1.2">
    <hashTree>
        <TestPlan>
            <ThreadGroup>
                <!-- 1000ä¸¦è¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ -->
                <stringProp name="ThreadGroup.num_threads">1000</stringProp>
                <!-- 300ç§’ã‹ã‘ã¦ãƒ©ãƒ³ãƒ—ã‚¢ãƒƒãƒ— -->
                <stringProp name="ThreadGroup.ramp_time">300</stringProp>
                <!-- å„ãƒ¦ãƒ¼ã‚¶ãƒ¼10å›ãƒ«ãƒ¼ãƒ— -->
                <stringProp name="ThreadGroup.loops">10</stringProp>
            </ThreadGroup>

            <!-- HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ: ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä¸€è¦§ -->
            <HTTPSampler>
                <stringProp name="HTTPSampler.domain">api.affiliate-system.com</stringProp>
                <stringProp name="HTTPSampler.path">/api/v1/campaigns</stringProp>
                <stringProp name="HTTPSampler.method">GET</stringProp>
            </HTTPSampler>

            <!-- HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ: ã‚¯ãƒªãƒƒã‚¯è¨˜éŒ² -->
            <HTTPSampler>
                <stringProp name="HTTPSampler.path">/api/v1/tracking/click</stringProp>
                <stringProp name="HTTPSampler.method">POST</stringProp>
            </HTTPSampler>
        </TestPlan>
    </hashTree>
</jmeterTestPlan>
```

---

### 2. Locust è² è·ãƒ†ã‚¹ãƒˆï¼ˆPythonï¼‰

```python
# locustfile.py

from locust import HttpUser, task, between
import random

class AffiliateSystemUser(HttpUser):
    wait_time = between(1, 3)  # 1-3ç§’å¾…æ©Ÿ

    def on_start(self):
        """ãƒ­ã‚°ã‚¤ãƒ³"""
        self.client.post("/api/v1/auth/login", json={
            "email": "test@example.com",
            "password": "password123"
        })

    @task(3)  # é‡ã¿ä»˜ã‘ï¼ˆ3å€é »ç¹ã«å®Ÿè¡Œï¼‰
    def view_campaigns(self):
        """ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä¸€è¦§é–²è¦§"""
        self.client.get("/api/v1/campaigns")

    @task(2)
    def view_dashboard(self):
        """ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é–²è¦§"""
        self.client.get("/api/v1/account/me")

    @task(1)
    def record_click(self):
        """ã‚¯ãƒªãƒƒã‚¯è¨˜éŒ²"""
        campaign_id = random.randint(1, 100)
        self.client.post("/api/v1/tracking/click", json={
            "campaign_id": campaign_id,
            "affiliate_id": 12345
        })

# å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰
# locust -f locustfile.py --users 1000 --spawn-rate 50 --host https://api.affiliate-system.com
```

---

### 3. k6 è² è·ãƒ†ã‚¹ãƒˆï¼ˆJavaScriptï¼‰

```javascript
// k6-load-test.js

import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
    stages: [
        { duration: '2m', target: 100 },   // 2åˆ†ã§100ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ã§
        { duration: '5m', target: 100 },   // 5åˆ†é–“100ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¶­æŒ
        { duration: '2m', target: 500 },   // 2åˆ†ã§500ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ã§
        { duration: '5m', target: 500 },   // 5åˆ†é–“500ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¶­æŒ
        { duration: '2m', target: 1000 },  // 2åˆ†ã§1000ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ã§
        { duration: '5m', target: 1000 },  // 5åˆ†é–“1000ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¶­æŒ
        { duration: '5m', target: 0 },     // ãƒ©ãƒ³ãƒ—ãƒ€ã‚¦ãƒ³
    ],
    thresholds: {
        http_req_duration: ['p(95)<500', 'p(99)<1000'],  // 95%ãŒ500msä»¥å†…
        http_req_failed: ['rate<0.01'],  // ã‚¨ãƒ©ãƒ¼ç‡1%æœªæº€
    },
};

export default function() {
    // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä¸€è¦§å–å¾—
    let campaignsRes = http.get('https://api.affiliate-system.com/api/v1/campaigns');

    check(campaignsRes, {
        'status is 200': (r) => r.status === 200,
        'response time < 500ms': (r) => r.timings.duration < 500,
    });

    sleep(1);

    // ã‚¯ãƒªãƒƒã‚¯è¨˜éŒ²
    let clickPayload = JSON.stringify({
        campaign_id: Math.floor(Math.random() * 100) + 1,
        affiliate_id: 12345
    });

    let clickRes = http.post(
        'https://api.affiliate-system.com/api/v1/tracking/click',
        clickPayload,
        { headers: { 'Content-Type': 'application/json' } }
    );

    check(clickRes, {
        'click recorded': (r) => r.status === 201,
    });

    sleep(2);
}
```

---

## ğŸ“Š ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°

### 1. New Relic APM çµ±åˆ

```php
<?php
// app/Http/Middleware/NewRelicTransaction.php

class NewRelicTransaction
{
    public function handle($request, Closure $next)
    {
        if (extension_loaded('newrelic')) {
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åè¨­å®š
            newrelic_name_transaction($request->route()->getName());

            // ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ 
            newrelic_add_custom_parameter('user_id', auth()->id());
            newrelic_add_custom_parameter('user_type', auth()->user()?->user_type);
        }

        $response = $next($request);

        return $response;
    }
}
```

---

### 2. ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªåˆ†æ

```sql
-- ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªãƒ­ã‚°æœ‰åŠ¹åŒ–
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;  -- 1ç§’ä»¥ä¸Š
SET GLOBAL log_queries_not_using_indexes = 'ON';

-- ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªåˆ†æï¼ˆpt-query-digestï¼‰
pt-query-digest /var/log/mysql/mysql-slow.log

-- å‡ºåŠ›ä¾‹
# Query 1: 12.5 QPS, 0.95x concurrency
# Time range: 2024-01-15 10:00:00 to 11:00:00
# Attribute    pct   total     min     max     avg     95%  stddev  median
# ============ === ======= ======= ======= ======= ======= ======= =======
# Count         45   45000
# Exec time     67   3420s     1ms     15s    76ms   150ms   234ms    45ms
# Lock time      0    12s     0us   100ms   267us   500us     2ms   100us
# Rows sent     40  500000       0   10000      11      20      15      10

SELECT * FROM conversions
WHERE affiliate_id = ?
  AND status = 'approved'
ORDER BY converted_at DESC
LIMIT 100;
```

---

ã“ã‚Œã‚‰ã®æœ€é©åŒ–ã«ã‚ˆã‚Šã€å¤§è¦æ¨¡ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã«è€ãˆã†ã‚‹é«˜æ€§èƒ½ãªASPã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚
